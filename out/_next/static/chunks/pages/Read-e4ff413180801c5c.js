(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(7154)}])},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7154:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return u}});var a=r(5893),n=r(7294),l=r(1163);let i=(0,r(1134).Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var o=r(3432),s=r(2743),c=r(8914);function u(){var e,t,r,u;let d=(0,l.useRouter)(),m="storyforge.session.v1",h="string"==typeof(null===(e=d.query)||void 0===e?void 0:e.chapter)?parseInt(d.query.chapter,10):void 0,p=(null===(t=d.query)||void 0===t?void 0:t.export)==="1"||(null===(r=d.query)||void 0===r?void 0:r.export)==="true",[g,f]=(0,n.useState)(""),[x,y]=(0,n.useState)(null),[b,v]=(0,n.useState)([]),[w,N]=(0,n.useState)(null),[S,j]=(0,n.useState)([]),[k,C]=(0,n.useState)(!1),[_,I]=(0,n.useState)(null),[E,U]=(0,n.useState)((0,c.RH)("6-8")),[$,O]=(0,n.useState)("fantasy"),[R,q]=(0,n.useState)(""),[M,H]=(0,n.useState)("warm, whimsical, gentle-humor"),A=(0,c.FY)(E),J=(0,c.VV)(E),[L,B]=(0,n.useState)(""),[Z,P]=(0,n.useState)(null),[T,z]=(0,n.useState)(null),[F,V]=(0,n.useState)(""),[W,X]=(0,n.useState)(!1),D="storyforge.streaming.v1";function G(e){let t=(e||"").toString();return t.trim()?/[<][a-zA-Z!\/?]/.test(t)?Y(t):function(e){let t=e||"";if(!t.trim())return"";let r=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/^######\s+(.*)$/gm,"<h6>$1</h6>")).replace(/^#####\s+(.*)$/gm,"<h5>$1</h5>")).replace(/^####\s+(.*)$/gm,"<h4>$1</h4>")).replace(/^###\s+(.*)$/gm,"<h3>$1</h3>")).replace(/^##\s+(.*)$/gm,"<h2>$1</h2>")).replace(/^#\s+(.*)$/gm,"<h1>$1</h1>")).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/(^|[^_])_([^_\n][^_]*)_/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).replace(/(^|[^*])\*([^*\n][^*]*)\*/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>/^<h[1-6]>/.test(e)?e:"<p>".concat(e.replace(/\n/g,"<br/>"),"</p>")).join("\n")}(t):""}function Y(e){let t=(e||"").toString().trim();if(!t)return"";try{let e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.html))return t.html;if("string"==typeof(null==t?void 0:t.output))return Y(t.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return Y(e.output)}}catch(e){}if(/[<][a-zA-Z!/?]/.test(t))return t;let r=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return t.split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>"<p>".concat(r(e).replace(/\n/g,"<br/>"),"</p>")).join("\n")}(0,n.useEffect)(()=>{let e=()=>{if(W){try{d.events.emit("routeChangeError")}catch(e){}throw"Route change aborted: streaming in progress"}},t=e=>{W&&(e.preventDefault(),e.returnValue="")};return d.events.on("routeChangeStart",e),window.addEventListener("beforeunload",t),()=>{d.events.off("routeChangeStart",e),window.removeEventListener("beforeunload",t)}},[W,d.events]),(0,n.useEffect)(()=>{try{let e=window.localStorage.getItem(D);if(!e)return;let t=JSON.parse(e);t&&"number"==typeof t.chapterId&&!S.some(e=>e.chapterId===t.chapterId)&&(X(!0),z(t.chapterId),V(t.chapterHeading||""),P(t.imageUrl||null),B(G(t.rawText||"")),C(!1))}catch(e){}},[]),(0,n.useEffect)(()=>{try{let t=window.localStorage.getItem(m);if(t){var e;let r=JSON.parse(t);f(null!==(e=r.title)&&void 0!==e?e:""),y(r.toc||null),v(Array.isArray(r.chapters)?r.chapters:[]),N(r.coverUrl||null),U((0,c.RH)(r.ageRange||"6-8")),O(r.genre||"fantasy"),q(r.keypoints||""),H(r.style||"warm, whimsical, gentle-humor");let a=(Array.isArray(r.scenes)?r.scenes:[]).map(e=>({...e,html:Y((null==e?void 0:e.html)||"")}));j(a);try{let e={...r,scenes:a};window.localStorage.setItem(m,JSON.stringify(e))}catch(e){}}}catch(e){}},[]),(0,n.useEffect)(()=>{var e;let t="string"==typeof(null===(e=d.query)||void 0===e?void 0:e.title)?d.query.title:"";!g&&t&&t.trim()&&f(t)},[null===(u=d.query)||void 0===u?void 0:u.title,g]),(0,n.useEffect)(()=>{(async()=>{if(p)try{C(!0);let{downloadUrl:e,filename:t}=await (0,s.WF)({scenes:S,coverUrl:w,meta:{title:g,toc:x,chapters:b}});if(e){let r=document.createElement("a");r.href=e,r.download=t||"".concat(g||"storybook",".html"),document.body.appendChild(r),r.click(),r.remove(),e.startsWith("blob:")&&URL.revokeObjectURL(e)}}catch(e){I(e.message||"Export failed")}finally{C(!1)}})()},[p]);let K=(0,n.useMemo)(()=>{if("number"==typeof h&&!isNaN(h)){let e=b.findIndex(e=>e.id===h);return e>=0?e:0}return Math.min(S.length,Math.max(0,(b.length,0)))},[h,b,S.length]);async function Q(){if(!b.length)return;let e=b[K];if(e&&!S.some(t=>t.chapterId===e.id))try{C(!0),I(null);let t=(0,c.RH)(E),r=(0,c.BU)(t),a={title:g,toc:x,priorHtml:S.map(e=>e.html),ageRange:t,lengthHint:r,genre:$,keypoints:R,style:M},n="[context: genre=".concat($,"; age=").concat(t,"; style=").concat(M,"; notes=").concat((R||"").slice(0,120),"]");X(!0),z(e.id),V(e.heading),B(""),P(null);let l=(async()=>{try{let r="".concat(g||"Untitled Codex"," (ages ").concat(t,"): Chapter ").concat(e.id," - ").concat(e.heading,". Genre ").concat($,". Style ").concat(M,"."),a=await (0,s.km)(r);return(null==a?void 0:a.url)&&P(a.url),(null==a?void 0:a.url)||null}catch(e){return null}})(),i="",o=!1;for await(let t of(0,s.nq)({context:a,chapterIndex:K,influence:n})){i+=t,!o&&t&&t.trim()&&(C(!1),o=!0),B(G(i));try{{let t={chapterId:e.id,chapterHeading:e.heading,rawText:i,imageUrl:Z};window.localStorage.setItem(D,JSON.stringify(t))}}catch(e){}}let u=G(i),d=null;try{d=await l}catch(e){d=null}let h=d||Z,p=[...S,{chapterId:e.id,chapterHeading:e.heading,html:u,imageUrl:h}];j(p);try{let e=window.localStorage.getItem(m),t={...e?JSON.parse(e):{},scenes:p};window.localStorage.setItem(m,JSON.stringify(t))}catch(e){}try{window.localStorage.removeItem(D)}catch(e){}}catch(e){I(e.message||"Chapter failed")}finally{X(!1),z(null),V(""),B(""),k&&C(!1)}}(0,n.useEffect)(()=>{Q()},[K,b.length]);let ee=(0,n.useMemo)(()=>{if("number"==typeof h&&!isNaN(h)){let e=S.find(e=>e.chapterId===h);if(e)return e}return S[K]},[S,K,h]),et=(0,n.useMemo)(()=>{if(!b.length)return;let e=Math.max(0,K-1);if(e!==K)return b[e]},[b,K]),er=(0,n.useMemo)(()=>{if(!b.length)return;let e=Math.min(b.length-1,K+1);if(e!==K)return b[e]},[b,K]),[ea,en]=(0,n.useState)(!1);async function el(e){try{en(!0),await new Promise(e=>setTimeout(e,460))}finally{en(!1),d.push({pathname:"/Read",query:e})}}return(0,a.jsxs)("div",{className:"min-h-screen text-amber-950 font-story-body ".concat(ea?"is-turning":""," page-turning"),children:[(0,a.jsx)("header",{className:"relative",children:(0,a.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,a.jsxs)("button",{onClick:()=>d.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,a.jsx)(i,{className:"h-4 w-4"})," Back to outline"]}),(0,a.jsx)("h1",{className:"mt-2 text-2xl font-story-title",children:g||"Untitled Codex"})]})}),(0,a.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative page",children:[k&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,a.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}),(0,a.jsx)("span",{children:"Engraving chapterâ€¦"})]})}),_&&(0,a.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:_}),(ee||W)&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-story-title ".concat(J," mb-2"),children:["Chapter ",ee?ee.chapterId:T,": ",ee?ee.chapterHeading:F]}),((null==ee?void 0:ee.imageUrl)||Z)&&(0,a.jsx)("img",{src:(null==ee?void 0:ee.imageUrl)||Z,alt:"Scene",className:"w-full h-auto rounded-lg border border-amber-200 mb-3"}),(0,a.jsx)("div",{className:"".concat(A," prose-amber prose-story dropcap max-w-none ").concat(W?"story-hit":""),dangerouslySetInnerHTML:{__html:ee?ee.html:L}})]})]})}),!k&&(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,a.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,a.jsx)("button",{onClick:()=>d.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>{et&&el({chapter:et.id,title:g||"Untitled Codex"})},disabled:!et,className:"rounded-xl border px-4 py-2 text-sm ".concat(et?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:et?"Previous: Chapter ".concat(et.id):"Previous"}),b.length>0&&S.length>=b.length?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>d.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,a.jsx)("button",{onClick:()=>d.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,a.jsx)("button",{onClick:()=>{er&&el({chapter:er.id,title:g||"Untitled Codex"})},disabled:!er,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(er?"":"opacity-50 cursor-not-allowed"),children:er?"Next: Chapter ".concat(er.id):"Next"})]})]})})})]})}}},function(e){e.O(0,[295,379,888,774,179],function(){return e(e.s=9749)}),_N_E=e.O()}]);