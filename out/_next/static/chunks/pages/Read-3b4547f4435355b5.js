(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(7154)}])},1134:function(e,t,r){"use strict";r.d(t,{Z:function(){return s}});var n=r(7294);let a=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),l=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()};var i={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let o=(0,n.forwardRef)((e,t)=>{let{color:r="currentColor",size:a=24,strokeWidth:o=2,absoluteStrokeWidth:s,className:c="",children:u,iconNode:d,...m}=e;return(0,n.createElement)("svg",{ref:t,...i,width:a,height:a,stroke:r,strokeWidth:s?24*Number(o)/Number(a):o,className:l("lucide",c),...m},[...d.map(e=>{let[t,r]=e;return(0,n.createElement)(t,r)}),...Array.isArray(u)?u:[u]])}),s=(e,t)=>{let r=(0,n.forwardRef)((r,i)=>{let{className:s,...c}=r;return(0,n.createElement)(o,{ref:i,iconNode:t,className:l("lucide-".concat(a(e)),s),...c})});return r.displayName="".concat(e),r}},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});let n=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},8914:function(e,t,r){"use strict";function n(e){let t=[{label:"1-3",min:1,max:3},{label:"4-8",min:4,max:8},{label:"6-8",min:6,max:8},{label:"9-15",min:9,max:15},{label:"16-20",min:16,max:20},{label:"21-25",min:21,max:25},{label:"25+",min:25,max:Number.POSITIVE_INFINITY,isPlus:!0}];function r(e){if(isNaN(e)||e<=0)return"6-8";if(e>=25)return"25+";let r=null;for(let n of t){if(n.isPlus)continue;let t=Math.abs((n.min+n.max)/2-e);(!r||t<r.distance)&&(r={label:n.label,distance:t})}return r?r.label:"6-8"}if(!e||"string"!=typeof e)return"6-8";let n=e.toString().trim();if(!n)return"6-8";if(t.some(e=>e.label===n))return n;let a=n.toLowerCase();if(/(toddler|infant|baby)/.test(a))return"1-3";if(/(kid|child|children|elementary|grade school)/.test(a))return"6-8";if(/(teen|pre-?teen|middle school)/.test(a))return"16-20";if(/(adult|grown|mature)/.test(a))return"21-25";let l=a.match(/\b(\d{1,3})\s*\+\b/);if(l){let e=parseInt(l[1],10);if(!isNaN(e))return e>=25?"25+":r(e)}let i=a.match(/\b(\d{1,3})\s*(?:[-–—]|to|through|–)\s*(\d{1,3})\b/);if(i){let e=parseInt(i[1],10),t=parseInt(i[2],10);if(!isNaN(e)&&!isNaN(t))return function(e,t){let n=Math.min(e,t),a=Math.max(e,t);return isNaN(n)||isNaN(a)||n<=0?"6-8":a>=25?"25+":r((n+a)/2)}(e,t)}let o=a.match(/\b(\d{1,3})\b/);if(o){let e=parseInt(o[1],10);if(!isNaN(e))return r(e)}return"6-8"}function a(e){let t=n(e);if(/^\d{1,3}\+$/.test(t)){let e=parseInt(t.replace(/\D/g,""),10);return{ageMin:isNaN(e)?void 0:e,ageMax:void 0}}let r=t.match(/^(\d{1,3})-(\d{1,3})$/);if(r){let e=parseInt(r[1],10),t=parseInt(r[2],10);return{ageMin:isNaN(e)?void 0:e,ageMax:isNaN(t)?void 0:t}}return{}}function l(e){let{ageMin:t,ageMax:r}=a(e);return function(e,t){if(void 0!==e&&void 0!==t){if(t<=3)return{range:[50,150],label:"1–3"};if(e>=4&&t<=8)return{range:[500,1e3],label:"4–8"};if(e>=9&&t<=15)return{range:[1500,3e3],label:"9–15"};if(e>=16&&t<=20)return{range:[2500,4e3],label:"16–20"};if(e>=21&&t<=25)return{range:[3e3,5e3],label:"21–25"};if(e>=26||t>=26)return{range:[3e3,6e3],label:"25+"}}return{range:[3e3,5e3],label:"default-adult"}}(t,r)}function i(e){let{ageMin:t,ageMax:r}=a(e);return void 0!==r&&r<=3?"prose-xl md:prose-2xl":void 0!==t&&void 0!==r&&t>=4&&r<=8?"prose-lg md:prose-xl":"prose"}function o(e){let{ageMin:t,ageMax:r}=a(e);return void 0!==r&&r<=3?"text-2xl md:text-3xl":void 0!==t&&void 0!==r&&t>=4&&r<=8?"text-xl md:text-2xl":"text-lg"}r.d(t,{BU:function(){return l},FY:function(){return i},RH:function(){return n},VV:function(){return o}})},7154:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return u}});var n=r(5893),a=r(7294),l=r(1163);let i=(0,r(1134).Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var o=r(3432),s=r(2743),c=r(8914);function u(){var e,t,r,u;let d=(0,l.useRouter)(),m="storyforge.session.v1",p="string"==typeof(null===(e=d.query)||void 0===e?void 0:e.chapter)?parseInt(d.query.chapter,10):void 0,h=(null===(t=d.query)||void 0===t?void 0:t.export)==="1"||(null===(r=d.query)||void 0===r?void 0:r.export)==="true",[f,g]=(0,a.useState)(""),[x,b]=(0,a.useState)(null),[y,v]=(0,a.useState)([]),[N,w]=(0,a.useState)(null),[S,j]=(0,a.useState)([]),[k,I]=(0,a.useState)(!1),[C,_]=(0,a.useState)(null),[E,M]=(0,a.useState)((0,c.RH)("6-8")),[$,O]=(0,a.useState)("fantasy"),[R,U]=(0,a.useState)(""),[A,q]=(0,a.useState)("warm, whimsical, gentle-humor"),H=(0,c.FY)(E),L=(0,c.VV)(E),[F,B]=(0,a.useState)(""),[J,P]=(0,a.useState)(null),[W,Z]=(0,a.useState)(null),[T,V]=(0,a.useState)(""),[z,Y]=(0,a.useState)(!1),D="storyforge.streaming.v1";function X(e){let t=(e||"").toString();return t.trim()?/[<][a-zA-Z!\/?]/.test(t)?K(t):function(e){let t=e||"";if(!t.trim())return"";let r=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/^######\s+(.*)$/gm,"<h6>$1</h6>")).replace(/^#####\s+(.*)$/gm,"<h5>$1</h5>")).replace(/^####\s+(.*)$/gm,"<h4>$1</h4>")).replace(/^###\s+(.*)$/gm,"<h3>$1</h3>")).replace(/^##\s+(.*)$/gm,"<h2>$1</h2>")).replace(/^#\s+(.*)$/gm,"<h1>$1</h1>")).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/(^|[^_])_([^_\n][^_]*)_/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).replace(/(^|[^*])\*([^*\n][^*]*)\*/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>/^<h[1-6]>/.test(e)?e:"<p>".concat(e.replace(/\n/g,"<br/>"),"</p>")).join("\n")}(t):""}function G(e,t,r){if(!e||!e.trim())return e;let n=e.split(/(<[^>]+>)/g),a=0,l=!1;return n.map(e=>e.startsWith("<")?e:e.replace(/([\w'’]+)(\s*)/g,(e,n,i)=>{if(a++,!l&&(null==r?void 0:r.skipFirstWord))return l=!0,"".concat(n).concat(i);let o=a>Math.max(0,a-t);return'<span class="'.concat(o?"word word-new":"word",'">').concat(n,"</span>").concat(i)})).join("")}function K(e){let t=(e||"").toString().trim();if(!t)return"";try{let e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.html))return t.html;if("string"==typeof(null==t?void 0:t.output))return K(t.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return K(e.output)}}catch(e){}if(/[<][a-zA-Z!/?]/.test(t))return t;let r=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return t.split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>"<p>".concat(r(e).replace(/\n/g,"<br/>"),"</p>")).join("\n")}(0,a.useEffect)(()=>{let e=()=>{if(z){try{d.events.emit("routeChangeError")}catch(e){}throw"Route change aborted: streaming in progress"}},t=e=>{z&&(e.preventDefault(),e.returnValue="")};return d.events.on("routeChangeStart",e),window.addEventListener("beforeunload",t),()=>{d.events.off("routeChangeStart",e),window.removeEventListener("beforeunload",t)}},[z,d.events]),(0,a.useEffect)(()=>{try{let e=window.localStorage.getItem(D);if(!e)return;let t=JSON.parse(e);t&&"number"==typeof t.chapterId&&!S.some(e=>e.chapterId===t.chapterId)&&(Y(!0),Z(t.chapterId),V(t.chapterHeading||""),P(t.imageUrl||null),B(X(t.rawText||"")),I(!1))}catch(e){}},[]),(0,a.useEffect)(()=>{try{let t=window.localStorage.getItem(m);if(t){var e;let r=JSON.parse(t);g(null!==(e=r.title)&&void 0!==e?e:""),b(r.toc||null),v(Array.isArray(r.chapters)?r.chapters:[]),w(r.coverUrl||null),M((0,c.RH)(r.ageRange||"6-8")),O(r.genre||"fantasy"),U(r.keypoints||""),q(r.style||"warm, whimsical, gentle-humor");let n=(Array.isArray(r.scenes)?r.scenes:[]).map(e=>({...e,html:K((null==e?void 0:e.html)||"")}));j(n);try{let e={...r,scenes:n};window.localStorage.setItem(m,JSON.stringify(e))}catch(e){}}}catch(e){}},[]),(0,a.useEffect)(()=>{var e;let t="string"==typeof(null===(e=d.query)||void 0===e?void 0:e.title)?d.query.title:"";!f&&t&&t.trim()&&g(t)},[null===(u=d.query)||void 0===u?void 0:u.title,f]),(0,a.useEffect)(()=>{(async()=>{if(h)try{I(!0);let{downloadUrl:e,filename:t}=await (0,s.WF)({scenes:S,coverUrl:N,meta:{title:f,toc:x,chapters:y}});if(e){let r=document.createElement("a");r.href=e,r.download=t||"".concat(f||"storybook",".html"),document.body.appendChild(r),r.click(),r.remove(),e.startsWith("blob:")&&URL.revokeObjectURL(e)}}catch(e){_(e.message||"Export failed")}finally{I(!1)}})()},[h]);let Q=(0,a.useMemo)(()=>{if("number"==typeof p&&!isNaN(p)){let e=y.findIndex(e=>e.id===p);return e>=0?e:0}return Math.min(S.length,Math.max(0,(y.length,0)))},[p,y,S.length]);async function ee(){if(!y.length)return;let e=y[Q];if(e&&!S.some(t=>t.chapterId===e.id))try{I(!0),_(null);let t=(0,c.RH)(E),r=(0,c.BU)(t),n={title:f,toc:x,priorHtml:S.map(e=>e.html),ageRange:t,lengthHint:r,genre:$,keypoints:R,style:A},a="[context: genre=".concat($,"; age=").concat(t,"; style=").concat(A,"; notes=").concat((R||"").slice(0,120),"]");Y(!0),Z(e.id),V(e.heading),B(""),P(null);let l=null;try{let r="".concat(f||"Untitled Codex"," (ages ").concat(t,"): Chapter ").concat(e.id," - ").concat(e.heading,". Genre ").concat($,". Style ").concat(A,"."),n=await (0,s.km)(r);(null==n?void 0:n.url)&&(l=n.url,P(n.url))}catch(e){l=null}let i="",o=!1,u=0;for await(let t of(0,s.nq)({context:n,chapterIndex:Q,influence:a,lengthHint:r})){i+=function(e){if(!e)return e;let t=function(e){if(!e)return e;let t=e.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");return t=(t=t.replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(parseInt(t,10)))).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}(e);t=t.replace(/^\s*Scene\b[\s:]*/i,"");for(let e=0;e<3;e++){let e=t.match(/\{[\s\S]*?\}/);if(!e)break;try{let r=JSON.parse(e[0]);if(r&&"object"==typeof r&&"name"in r&&"parameters"in r){t=t.slice(0,e.index||0)+t.slice((e.index||0)+e[0].length);continue}}catch(e){}break}return t}(t),!o&&t&&t.trim()&&(I(!1),o=!0);let r=X(i),n=r.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),a=n?n.split(" ").length:0,l=Math.max(0,a-u),s=G(r,l,{skipFirstWord:!0});u=a,B(s);try{{let t={chapterId:e.id,chapterHeading:e.heading,rawText:i,imageUrl:J};window.localStorage.setItem(D,JSON.stringify(t))}}catch(e){}}let d=(()=>{let e=X(i);return'<div class="words-flash">'.concat(G(e,0,{skipFirstWord:!0}),"</div>")})(),p=l||J,h=[...S,{chapterId:e.id,chapterHeading:e.heading,html:d,imageUrl:p}];j(h);try{let e=window.localStorage.getItem(m),t={...e?JSON.parse(e):{},scenes:h};window.localStorage.setItem(m,JSON.stringify(t))}catch(e){}try{window.localStorage.removeItem(D)}catch(e){}}catch(e){_(e.message||"Chapter failed")}finally{Y(!1),Z(null),V(""),B(""),k&&I(!1)}}(0,a.useEffect)(()=>{ee()},[Q,y.length]);let et=(0,a.useMemo)(()=>{if("number"==typeof p&&!isNaN(p)){let e=S.find(e=>e.chapterId===p);if(e)return e}return S[Q]},[S,Q,p]),er=(0,a.useMemo)(()=>{if(!y.length)return;let e=Math.max(0,Q-1);if(e!==Q)return y[e]},[y,Q]),en=(0,a.useMemo)(()=>{if(!y.length)return;let e=Math.min(y.length-1,Q+1);if(e!==Q)return y[e]},[y,Q]),[ea,el]=(0,a.useState)(!1);async function ei(e){try{el(!0),await new Promise(e=>setTimeout(e,460))}finally{el(!1),d.push({pathname:"/Read",query:e})}}return(0,n.jsxs)("div",{className:"min-h-screen text-amber-950 font-story-body ".concat(ea?"is-turning":""," page-turning"),children:[(0,n.jsx)("header",{className:"relative",children:(0,n.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,n.jsxs)("button",{onClick:()=>d.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,n.jsx)(i,{className:"h-4 w-4"})," Back to outline"]}),(0,n.jsx)("h1",{className:"mt-2 text-2xl font-story-title",children:f||"StoryForge"})]})}),(0,n.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative page",children:[k&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,n.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}),(0,n.jsx)("span",{children:"Engraving chapter…"})]})}),C&&(0,n.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:C}),(et||z)&&(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"font-story-title ".concat(L," mb-2"),children:["Chapter ",et?et.chapterId:W,": ",et?et.chapterHeading:T]}),((null==et?void 0:et.imageUrl)||J)&&(0,n.jsx)("img",{src:(null==et?void 0:et.imageUrl)||J,alt:"Scene",className:"w-full h-auto rounded-lg border border-amber-200 mb-3"}),(0,n.jsx)("div",{className:"".concat(H," prose-amber prose-story dropcap max-w-none ").concat(z?"story-hit":""),dangerouslySetInnerHTML:{__html:et?et.html:F}})]})]})}),!k&&(0,n.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,n.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,n.jsx)("button",{onClick:()=>d.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>{er&&ei({chapter:er.id,title:f||"Untitled Codex"})},disabled:!er,className:"rounded-xl border px-4 py-2 text-sm ".concat(er?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:er?"Previous: Chapter ".concat(er.id):"Previous"}),y.length>0&&S.length>=y.length?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:()=>d.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,n.jsx)("button",{onClick:()=>d.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,n.jsx)("button",{onClick:()=>{en&&ei({chapter:en.id,title:f||"Untitled Codex"})},disabled:!en,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(en?"":"opacity-50 cursor-not-allowed"),children:en?"Next: Chapter ".concat(en.id):"Next"})]})]})})})]})}}},function(e){e.O(0,[154,743,888,774,179],function(){return e(e.s=9749)}),_N_E=e.O()}]);