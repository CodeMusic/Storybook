(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{4349:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Outline",function(){return r(7563)}])},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});let n=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7326:function(e,t,r){"use strict";r.d(t,{T:function(){return l}});var n=r(5893),i=r(7294),a=r(9346);function l(e){let{coverUrl:t,title:r,onBroken:l}=e,[s,o]=(0,i.useState)(!1);return(0,n.jsxs)(a.Zb,{className:"bg-amber-50/80 border-amber-300 overflow-hidden",children:[t&&(0,n.jsx)("img",{src:t,alt:"Cover",className:"w-full aspect-[4/3] object-cover",onError:function(){if(!s){o(!0);try{l&&l()}catch(e){}}}}),(0,n.jsx)(a.Ol,{children:(0,n.jsx)(a.ll,{className:"text-amber-950",children:"StoryForge"})}),(0,n.jsxs)(a.aY,{className:"text-sm",children:[(0,n.jsx)("div",{className:"text-amber-900/70 uppercase text-xs",children:"Title"}),(0,n.jsx)("div",{className:"font-serif text-lg",children:r})]})]})}},9346:function(e,t,r){"use strict";r.d(t,{Ol:function(){return a},Zb:function(){return i},aY:function(){return s},ll:function(){return l}});var n=r(5893);r(7294);let i=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"rounded-2xl border bg-white ".concat(t),...r})},a=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"px-4 py-3 border-b ".concat(t),...r})},l=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"text-lg font-semibold ".concat(t),...r})},s=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"px-4 py-3 ".concat(t),...r})}},8914:function(e,t,r){"use strict";function n(e){let t=[{label:"1-3",min:1,max:3},{label:"4-8",min:4,max:8},{label:"6-8",min:6,max:8},{label:"9-15",min:9,max:15},{label:"16-20",min:16,max:20},{label:"21-25",min:21,max:25},{label:"25+",min:25,max:Number.POSITIVE_INFINITY,isPlus:!0}];function r(e){if(isNaN(e)||e<=0)return"6-8";if(e>=25)return"25+";let r=null;for(let n of t){if(n.isPlus)continue;let t=Math.abs((n.min+n.max)/2-e);(!r||t<r.distance)&&(r={label:n.label,distance:t})}return r?r.label:"6-8"}if(!e||"string"!=typeof e)return"6-8";let n=e.toString().trim();if(!n)return"6-8";if(t.some(e=>e.label===n))return n;let i=n.toLowerCase();if(/(toddler|infant|baby)/.test(i))return"1-3";if(/(kid|child|children|elementary|grade school)/.test(i))return"6-8";if(/(teen|pre-?teen|middle school)/.test(i))return"16-20";if(/(adult|grown|mature)/.test(i))return"21-25";let a=i.match(/\b(\d{1,3})\s*\+\b/);if(a){let e=parseInt(a[1],10);if(!isNaN(e))return e>=25?"25+":r(e)}let l=i.match(/\b(\d{1,3})\s*(?:[-–—]|to|through|–)\s*(\d{1,3})\b/);if(l){let e=parseInt(l[1],10),t=parseInt(l[2],10);if(!isNaN(e)&&!isNaN(t))return function(e,t){let n=Math.min(e,t),i=Math.max(e,t);return isNaN(n)||isNaN(i)||n<=0?"6-8":i>=25?"25+":r((n+i)/2)}(e,t)}let s=i.match(/\b(\d{1,3})\b/);if(s){let e=parseInt(s[1],10);if(!isNaN(e))return r(e)}return"6-8"}function i(e){let t=n(e);if(/^\d{1,3}\+$/.test(t)){let e=parseInt(t.replace(/\D/g,""),10);return{ageMin:isNaN(e)?void 0:e,ageMax:void 0}}let r=t.match(/^(\d{1,3})-(\d{1,3})$/);if(r){let e=parseInt(r[1],10),t=parseInt(r[2],10);return{ageMin:isNaN(e)?void 0:e,ageMax:isNaN(t)?void 0:t}}return{}}function a(e){let{ageMin:t,ageMax:r}=i(e);return function(e,t){if(void 0!==e&&void 0!==t){if(t<=3)return{range:[50,150],label:"1–3"};if(e>=4&&t<=8)return{range:[500,1e3],label:"4–8"};if(e>=9&&t<=15)return{range:[1500,3e3],label:"9–15"};if(e>=16&&t<=20)return{range:[2500,4e3],label:"16–20"};if(e>=21&&t<=25)return{range:[3e3,5e3],label:"21–25"};if(e>=26||t>=26)return{range:[3e3,6e3],label:"25+"}}return{range:[3e3,5e3],label:"default-adult"}}(t,r)}function l(e){let{ageMin:t,ageMax:r}=i(e);return void 0!==r&&r<=3?"prose-xl md:prose-2xl":void 0!==t&&void 0!==r&&t>=4&&r<=8?"prose-lg md:prose-xl":"prose"}function s(e){let{ageMin:t,ageMax:r}=i(e);return void 0!==r&&r<=3?"text-2xl md:text-3xl":void 0!==t&&void 0!==r&&t>=4&&r<=8?"text-xl md:text-2xl":"text-lg"}r.d(t,{BU:function(){return a},FY:function(){return l},RH:function(){return n},VV:function(){return s}})},1207:function(e,t,r){"use strict";function n(e){let t=e.replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),r=[],n=1;function i(e,t){let i=e.replace(/^#{1,6}\s+/,"").trim(),a=(i=i.replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim())||"Chapter ".concat(n),l=(t||"").trim()||void 0;r.push({id:n++,heading:a,synopsis:l})}for(let e=0;e<t.length;e++){let r=t[e],n=r.match(/^\s*(?:\d+[\).]|[•\-*]|\d+\s+)\s*(.*)$/);if(n){let e=n[1].trim().split(/[—–\-:]\s+/);i((e[0]||"").replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim(),(e.slice(1).join(" - ")||"").trim());continue}let a=r.match(/^#{1,6}\s+(.*)$/);if(a){if(/table of contents/i.test(a[1]))continue;let r=t[e+1],n=r&&!/^#{1,6}\s+/.test(r)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(r);i(a[1],n?r:void 0),n&&e++;continue}let l=r.match(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*(.*)$/i);if(l){let r=t[e+1],n=r&&!/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i.test(r)&&!/^#{1,6}\s+/.test(r)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(r);i(l[1],n?r:void 0),n&&e++;continue}}if(0===r.length){let e=t.map(e=>e.replace(/\s{2,}$/,"").trim()).filter(Boolean).filter(e=>!/^table of contents$/i.test(e));if(e.length>=2)for(let t of e)i(t)}return r}function i(e,t){let r=t.split(/\r?\n/).filter(Boolean).slice(0,2).join(", ");return"".concat(e,": ").concat(r,". Cozy watercolor, soft light, storybook composition, ancient relic/tech motif.")}r.d(t,{B:function(){return n},Z:function(){return i}})},7563:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return f}});var n=r(5893),i=r(7294),a=r(1163),l=r(1891);let s=(0,r(1134).Z)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);var o=r(3432),c=r(7326),d=r(1207),u=r(2743),m=r(8914);function f(){let e=(0,a.useRouter)(),t="storyforge.session.v1",r="storyforge.seed.lock.v1",[f,p]=(0,i.useState)(""),[h,g]=(0,i.useState)(""),[x,b]=(0,i.useState)((0,m.RH)("6-8")),[v,y]=(0,i.useState)("fantasy"),[N,S]=(0,i.useState)(8),[w,j]=(0,i.useState)(""),[C,k]=(0,i.useState)("warm, whimsical, gentle-humor"),[I,O]=(0,i.useState)(null),[E,B]=(0,i.useState)(!0),[R,U]=(0,i.useState)(null),[M,T]=(0,i.useState)(null),[_,$]=(0,i.useState)([]),[J,D]=(0,i.useState)([]),[H,z]=(0,i.useState)(!1),[G,P]=(0,i.useState)(0),Z=(0,i.useRef)(!1);function F(e,t){let r=Math.max(1,Math.floor(t||0)),n=e.slice(0,r).map((e,t)=>({...e,id:t+1}));if(n.length===r)return n;let i=[];for(let e=n.length;e<r;e++)i.push({id:e+1,heading:"Chapter ".concat(e+1),synopsis:void 0});return[...n,...i]}return(0,i.useEffect)(()=>{try{let r=window.localStorage.getItem(t);if(r){var e;let n=JSON.parse(r),i=new URLSearchParams(window.location.search),a=(null==i?void 0:i.get("reseed"))==="1";if(a&&(0,u.$y)(),n.premise&&n.premise.includes("Cannot access uninitialized variable")){console.log("DEBUG: Sanitizing corrupted premise in localStorage"),n.premise="";try{window.localStorage.setItem(t,JSON.stringify(n))}catch(e){}}if(p(null!==(e=n.title)&&void 0!==e?e:""),g(n.premise||""),b((0,m.RH)(n.ageRange||"6-8")),y(n.genre||"fantasy"),S("number"==typeof n.chaptersTarget?n.chaptersTarget:8),j(n.keypoints||""),k(n.style||"warm, whimsical, gentle-humor"),O(n.coverUrl||null),a){T(null),$([]),j("");try{let e={...n,toc:null,chapters:[],seedSignature:void 0,keypoints:""};window.localStorage.setItem(t,JSON.stringify(e))}catch(e){}}else T(n.toc||null),$(Array.isArray(n.chapters)?n.chapters:[]);try{let e=(Array.isArray(n.scenes)?n.scenes:[]).map(e=>null==e?void 0:e.chapterId).filter(e=>"number"==typeof e);D(e)}catch(e){}}}catch(e){console.error("DEBUG Outline: localStorage error =",e)}finally{z(!0)}},[]),(0,i.useEffect)(()=>{(async()=>{try{if(console.log("DEBUG Outline useEffect: hydrated =",H,"toc =",M),!H)return;let e=JSON.stringify({title:f,premise:h,ageRange:(0,m.RH)(x),genre:v,chaptersTarget:N,keypoints:w,style:C});try{let r=window.localStorage.getItem(t),n=r?JSON.parse(r):{};if(n.seedSignature!==e){(0,u.$y)();let r={...n,seedSignature:e,toc:null,chapters:[]};try{window.localStorage.setItem(t,JSON.stringify(r))}catch(e){}T(null),$([])}}catch(e){}let n=new URLSearchParams(window.location.search),i=(null==n?void 0:n.get("reseed"))==="1";if(!i&&M&&0===G&&0===_.length){let e=(M||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,""),r=(0,d.B)(e),n=F(r,N);T(e),$(n);try{let r=window.localStorage.getItem(t),i={...r?JSON.parse(r):{},toc:e,chapters:n};window.localStorage.setItem(t,JSON.stringify(i))}catch(e){}return}if(!i&&M&&0===G||Z.current)return;try{let t=window.sessionStorage.getItem(r);if(!i&&0===G&&t===e){console.log("DEBUG Outline: Seeding locked for signature, skipping duplicate call");return}}catch(e){}let a="Cannot access uninitialized variable",l=f&&!f.includes(a)?f:"",s=h&&!h.includes(a)?h:"";console.log("DEBUG Outline: evaluating seed readiness. titleSafe =",l,"premiseSafe =",s),B(!0),U(null),Z.current=!0;try{window.sessionStorage.setItem(r,e)}catch(e){}if(!(l&&l.trim()||s&&s.trim())){console.log("DEBUG Outline: Missing title/premise after sanitize, setting error"),U("Missing seed info. Return and provide an idea or description."),B(!1);return}let o={title:l||"Untitled Codex",premise:s||l,prompt:s||l||"Untitled Codex",ageRange:(0,m.RH)(x),genre:v,chapters:N,keypoints:w||void 0,style:C,policyHint:"Fictionalize any sensitive or political content; avoid real names; keep it age-appropriate and non-political."};console.log("DEBUG Outline: Sending payload to seedStory @",(null===u.bV||void 0===u.bV?void 0:u.bV.seed)||"n/a","payload =",o);let{toc:c}=await (0,u.Mq)(o);console.log("DEBUG: Received TOC:",c);let p=(c||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,"");T(p);let g=(0,d.B)(p),b=F(g,N);$(b);try{let e=window.localStorage.getItem(t),r={...e?JSON.parse(e):{},toc:p,chapters:b};window.localStorage.setItem(t,JSON.stringify(r))}catch(e){}}catch(e){U((null==e?void 0:e.message)||"Seeding outline failed")}finally{B(!1),Z.current=!1;try{window.sessionStorage.removeItem(r)}catch(e){}G>0&&P(0)}})()},[H,G,f,h,x,v,N,w,C]),(0,n.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,n.jsx)("div",{className:"relative",children:(0,n.jsxs)("div",{className:"mx-auto max-w-6xl px-4 py-8",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)(l.E.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl bg-amber-200/70 p-2 shadow",children:(0,n.jsx)(s,{className:"h-6 w-6"})}),(0,n.jsx)(l.E.h1,{initial:{opacity:0,y:0},animate:{opacity:1,y:0},className:"text-2xl md:text-3xl font-serif tracking-wide",children:"Outline"}),(0,n.jsx)("button",{onClick:()=>e.push("/"),className:"ml-auto inline-flex items-center text-sm text-amber-900 underline hover:no-underline",children:"Forge New Story"})]}),(0,n.jsx)("p",{className:"mt-1 text-amber-900/80",children:f||"Untitled Codex"})]})}),(0,n.jsx)("main",{className:"relative mx-auto max-w-6xl px-4 pb-20",children:(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,n.jsx)("div",{className:"lg:col-span-1",children:(0,n.jsx)(c.T,{coverUrl:I,title:f||"Untitled Codex"})}),(0,n.jsxs)("div",{className:"lg:col-span-2",children:[(0,n.jsxs)("div",{className:"relative rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px]",children:[E&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,n.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}),(0,n.jsx)("span",{children:"Engraving your table of contents…"})]})}),R&&(0,n.jsxs)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:[(0,n.jsx)("div",{children:R}),(0,n.jsx)("div",{className:"mt-2",children:(0,n.jsx)("button",{onClick:()=>P(e=>e+1),className:"rounded-lg bg-red-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]}),!E&&!R&&_.length>0&&(0,n.jsx)("ol",{className:"space-y-2",children:_.map(t=>{let r=J.includes(t.id);return(0,n.jsxs)("li",{className:"rounded-xl border p-3 cursor-pointer ".concat(r?"border-emerald-300 bg-emerald-50/60":"border-amber-200 bg-white/70"),onClick:()=>e.push({pathname:"/Read",query:{chapter:t.id,title:f||"Untitled Codex"}}),children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"font-serif font-semibold",children:[t.id,". ",t.heading]}),(0,n.jsx)("div",{className:"text-xs text-amber-900/70",children:r?"engraved":"tap to generate"})]}),t.synopsis&&(0,n.jsx)("div",{className:"text-sm text-amber-900/80",children:t.synopsis})]},t.id)})}),!E&&!R&&0===_.length&&(0,n.jsxs)("div",{className:"text-amber-900/80",children:[(0,n.jsx)("div",{children:"No chapters detected. The model may have declined or produced non-TOC text."}),(0,n.jsx)("div",{className:"mt-2",children:(0,n.jsx)("button",{onClick:()=>P(e=>e+1),className:"rounded-lg bg-amber-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]})]}),(0,n.jsx)("div",{className:"mt-4 flex justify-end gap-2",children:_.length>0&&J.length>=_.length&&(0,n.jsx)("button",{onClick:()=>e.push("/Read?export=1"),className:"inline-flex items-center justify-center rounded-xl bg-amber-600 text-white px-5 py-3 shadow hover:bg-amber-700",disabled:E,children:"Export Full Book"})})]})]})})]})}}},function(e){e.O(0,[154,913,743,888,774,179],function(){return e(e.s=4349)}),_N_E=e.O()}]);