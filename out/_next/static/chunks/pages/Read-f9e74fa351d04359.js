(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(t,e,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(7154)}])},3432:function(t,e,r){"use strict";r.d(e,{Z:function(){return n}});let n=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7154:function(t,e,r){"use strict";r.r(e),r.d(e,{default:function(){return s}});var n=r(5893),o=r(7294),a=r(1163);let i=(0,r(1134).Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var l=r(3432),c=r(2743);function s(){var t,e,r,s;let u=(0,a.useRouter)(),d="storyforge.session.v1",p="string"==typeof(null===(t=u.query)||void 0===t?void 0:t.chapter)?parseInt(u.query.chapter,10):void 0,m=(null===(e=u.query)||void 0===e?void 0:e.export)==="1"||(null===(r=u.query)||void 0===r?void 0:r.export)==="true",[h,f]=(0,o.useState)(""),[g,y]=(0,o.useState)(null),[b,x]=(0,o.useState)([]),[w,v]=(0,o.useState)(null),[N,S]=(0,o.useState)([]),[j,k]=(0,o.useState)(!1),[E,C]=(0,o.useState)(null);(0,o.useEffect)(()=>{try{let e=window.localStorage.getItem(d);if(e){var t;let r=JSON.parse(e);f(null!==(t=r.title)&&void 0!==t?t:""),y(r.toc||null),x(Array.isArray(r.chapters)?r.chapters:[]),v(r.coverUrl||null);let n=(Array.isArray(r.scenes)?r.scenes:[]).map(t=>({...t,html:function t(e){let r=(e||"").toString().trim();if(!r)return"";try{let e=JSON.parse(r);if(Array.isArray(e)&&e.length>0){let r=e[0];if("string"==typeof(null==r?void 0:r.html))return r.html;if("string"==typeof(null==r?void 0:r.output))return t(r.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return t(e.output)}}catch(t){}if(/[<][a-zA-Z!/?]/.test(r))return r;let n=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return r.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>"<p>".concat(n(t).replace(/\n/g,"<br/>"),"</p>")).join("\n")}((null==t?void 0:t.html)||"")}));S(n);try{let t={...r,scenes:n};window.localStorage.setItem(d,JSON.stringify(t))}catch(t){}}}catch(t){}},[]),(0,o.useEffect)(()=>{var t;let e="string"==typeof(null===(t=u.query)||void 0===t?void 0:t.title)?u.query.title:"";!h&&e&&e.trim()&&f(e)},[null===(s=u.query)||void 0===s?void 0:s.title,h]),(0,o.useEffect)(()=>{(async()=>{if(m)try{k(!0);let{downloadUrl:t,filename:e}=await (0,c.WF)({htmlPages:N.map(t=>t.html),coverUrl:w,meta:{title:h,toc:g,chapters:b}});if(t){let r=document.createElement("a");r.href=t,r.download=e||"".concat(h||"storybook",".html"),document.body.appendChild(r),r.click(),r.remove(),t.startsWith("blob:")&&URL.revokeObjectURL(t)}}catch(t){C(t.message||"Export failed")}finally{k(!1)}})()},[m]);let O=(0,o.useMemo)(()=>{if("number"==typeof p&&!isNaN(p)){let t=b.findIndex(t=>t.id===p);return t>=0?t:0}return Math.min(N.length,Math.max(0,(b.length,0)))},[p,b,N.length]);async function U(){if(!b.length)return;let t=b[O];if(t&&!N.some(e=>e.chapterId===t.id))try{k(!0),C(null);let e={title:h,toc:g,priorHtml:N.map(t=>t.html)},{html:r}=await (0,c.Yl)({context:e,chapterIndex:O}),n=null;try{n=(await (0,c.km)("".concat(h,": ").concat(t.heading,". ").concat(r.slice(0,180),"..."))).url}catch(t){}let o=[...N,{chapterId:t.id,chapterHeading:t.heading,html:r,imageUrl:n}];S(o);try{let t=window.localStorage.getItem(d),e={...t?JSON.parse(t):{},scenes:o};window.localStorage.setItem(d,JSON.stringify(e))}catch(t){}}catch(t){C(t.message||"Chapter failed")}finally{k(!1)}}(0,o.useEffect)(()=>{U()},[O,b.length]);let A=(0,o.useMemo)(()=>{if("number"==typeof p&&!isNaN(p)){let t=N.find(t=>t.chapterId===p);if(t)return t}return N[O]},[N,O,p]),_=(0,o.useMemo)(()=>{if(!b.length)return;let t=Math.max(0,O-1);if(t!==O)return b[t]},[b,O]),I=(0,o.useMemo)(()=>{if(!b.length)return;let t=Math.min(b.length-1,O+1);if(t!==O)return b[t]},[b,O]);return(0,n.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,n.jsx)("header",{className:"relative",children:(0,n.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,n.jsxs)("button",{onClick:()=>u.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,n.jsx)(i,{className:"h-4 w-4"})," Back to outline"]}),(0,n.jsx)("h1",{className:"mt-2 text-2xl font-serif",children:h||"Untitled Codex"})]})}),(0,n.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative",children:[j&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,n.jsx)(l.Z,{className:"h-5 w-5 animate-spin"}),(0,n.jsx)("span",{children:"Engraving chapter…"})]})}),E&&(0,n.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:E}),A&&(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"font-serif text-xl mb-2",children:["Chapter ",A.chapterId,": ",A.chapterHeading]}),A.imageUrl&&(0,n.jsx)("img",{src:A.imageUrl,alt:"Scene",className:"w-full h-auto rounded-lg border border-amber-200 mb-3"}),(0,n.jsx)("div",{className:"prose prose-amber max-w-none",dangerouslySetInnerHTML:{__html:A.html}})]})]})}),!j&&(0,n.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,n.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,n.jsx)("button",{onClick:()=>u.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>{_&&u.push({pathname:"/Read",query:{chapter:_.id,title:h||"Untitled Codex"}})},disabled:!_,className:"rounded-xl border px-4 py-2 text-sm ".concat(_?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:_?"Previous: Chapter ".concat(_.id):"Previous"}),b.length>0&&N.length>=b.length?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:()=>u.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,n.jsx)("button",{onClick:()=>u.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,n.jsx)("button",{onClick:()=>{I&&u.push({pathname:"/Read",query:{chapter:I.id,title:h||"Untitled Codex"}})},disabled:!I,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(I?"":"opacity-50 cursor-not-allowed"),children:I?"Next: Chapter ".concat(I.id):"Next"})]})]})})})]})}},2743:function(t,e,r){"use strict";r.d(e,{Mq:function(){return h},WF:function(){return b},Yl:function(){return f},bV:function(){return c},km:function(){return y},o9:function(){return x},tH:function(){return a}});var n=r(4406),o=r(8834).lW;let a="https://n8n.codemusic.ca/webhook",i=n.env.NEXT_PUBLIC_N8N_USER||"siteuser",l=n.env.NEXT_PUBLIC_N8N_PASS||"codemusai",c={prime:"".concat(a,"/seedInfo"),seed:"".concat(a,"/seedStory"),chapter:"".concat(a,"/expandChapter"),image:"".concat(a,"/genImage"),export:"".concat(a,"/exportBook")};function s(){let t="".concat(i,":").concat(l);try{let e="function"==typeof btoa?btoa(t):o.from(t).toString("base64");return"Basic ".concat(e)}catch(t){return""}}function u(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e5,n=new AbortController,o=setTimeout(()=>n.abort(),r);return fetch(t,{...e,signal:n.signal}).finally(()=>clearTimeout(o))}async function d(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s()},body:JSON.stringify(e)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));if(!n)throw Error("Empty response");return n}async function p(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s()},body:JSON.stringify(e)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));try{return JSON.parse(n)}catch(t){throw Error("Invalid JSON response")}}async function m(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s()},body:JSON.stringify(e)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));return n}async function h(t){console.log("DEBUG seedStory: endpoint =",c.seed),console.log("DEBUG seedStory: payload =",t);try{let e=await d(c.seed,t);console.log("DEBUG seedStory: raw response =",e);let r=function(t){let e=(t||"").toString().trim();if(!e)return e;try{let t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){let e=t[0];if("string"==typeof(null==e?void 0:e.toc))return e.toc;if("string"==typeof(null==e?void 0:e.output))return e.output}if("object"==typeof t&&t){if("string"==typeof t.toc)return t.toc;if("string"==typeof t.output)return t.output}}catch(t){}return e}(e);return console.log("DEBUG seedStory: parsed toc =",r),{toc:r}}catch(t){throw console.error("DEBUG seedStory: error =",t),t}}async function f(t){return{html:function t(e){let r=(e||"").toString().trim();if(!r)return"";try{let e=JSON.parse(r);if(Array.isArray(e)&&e.length>0){let r=e[0];if("string"==typeof(null==r?void 0:r.html))return r.html;if("string"==typeof(null==r?void 0:r.output))return t(r.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return t(e.output)}}catch(t){}return/[<][a-zA-Z!/?]/.test(r)?r:r.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>{let e=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br/>");return"<p>".concat(e,"</p>")}).join("\n")}(await d(c.chapter,t))}}async function g(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s()},body:JSON.stringify(e)}),n=r.headers.get("content-type")||"";if(!r.ok)throw Error(await r.text().catch(()=>"")||"Endpoint error ".concat(r.status));if(n.startsWith("image/")){let t=await r.blob();return URL.createObjectURL(t)}let o=await r.text();try{let t=JSON.parse(o);if("string"==typeof(null==t?void 0:t.url))return t.url;if("string"==typeof(null==t?void 0:t.data)){let e=(null==t?void 0:t.mime)||(null==t?void 0:t.type)||"image/png";if(t.data.startsWith("data:"))return t.data;return"data:".concat(e,";base64,").concat(t.data)}}catch(t){}let a=o.trim();if(!a)throw Error("Empty response");return a}async function y(t){return{url:await g(c.image,{prompt:t})}}async function b(t){try{var e;let{htmlPages:r,coverUrl:n,meta:o}=t||{},a=((null==o?void 0:o.title)||"Untitled Codex").toString(),i=a.replace(/[^a-z0-9\- _\(\)\[\]]+/gi,"_").trim()||"storybook",l=Array.isArray(r)?r.join("\n\n<hr/>\n\n"):"",c="string"==typeof(null==o?void 0:o.toc)&&o.toc.trim()?'<pre style="white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:12px;">'.concat(o.toc,"</pre>"):"",s='<!doctype html>\n<html lang="en">\n<head>\n  <meta charset="utf-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1" />\n  <title>'.concat(a,'</title>\n  <style>\n    body { color:#451a03; background:#fffbeb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; }\n    h1, h2, h3 { font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; color:#7c2d12; }\n    .container { max-width: 780px; margin: 0 auto; }\n    .card { background: rgba(255, 237, 213, 0.6); border: 1px solid #fdba74; border-radius: 16px; padding: 16px; }\n    .meta { color:#92400e; font-size: 0.9rem; }\n    hr { border:0; border-top:1px solid #fed7aa; margin: 24px 0; }\n    .chapter { margin: 16px 0; }\n    .chapter img { max-width:100%; height:auto; border-radius: 8px; border:1px solid #fcd34d; }\n    .prose p { line-height: 1.7; margin: 10px 0; }\n  </style>\n  <meta name="generator" content="Storyforge" />\n  <meta name="description" content="Exported Storyforge book" />\n  <meta name="author" content="Storyforge" />\n  <meta name="storyforge:title" content="').concat(a,'" />\n  <meta name="storyforge:chapters" content="').concat(((null==o?void 0:null===(e=o.chapters)||void 0===e?void 0:e.length)||0).toString(),'" />\n  <script>/* Standalone export generated locally without server dependency */</script>\n  <link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><text y=\'14\' font-size=\'14\'>\uD83D\uDCDC</text></svg>">\n  <meta name="color-scheme" content="light" />\n  <meta name="theme-color" content="#f59e0b" />\n  <meta name="apple-mobile-web-app-capable" content="yes" />\n  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />\n  <meta name="apple-mobile-web-app-title" content="').concat(a,'" />\n  <meta name="format-detection" content="telephone=no" />\n  <meta name="mobile-web-app-capable" content="yes" />\n</head>\n<body>\n  <main class="container">\n    <div class="card">\n      <h1>').concat(a,"</h1>\n      ").concat(n?'<img src="'.concat(n,'" alt="Cover" style="max-width:100%;height:auto;border:1px solid #e2c084;border-radius:12px;margin:12px 0;"/>'):"","\n      ").concat(c,'\n    </div>\n    <section class="prose chapter">').concat(l,"</section>\n  </main>\n</body>\n</html>"),u=new Blob([s],{type:"text/html;charset=utf-8"});return{downloadUrl:URL.createObjectURL(u),filename:"".concat(i,".html")}}catch(e){try{return{downloadUrl:await d(c.export,t)}}catch(t){return{downloadUrl:null}}}}async function x(t){try{let e=await p(c.prime,t),r=t=>{let e=(t||"").trim(),r=e.match(/```\s*json\s*([\s\S]*?)```/i)||e.match(/```\s*([\s\S]*?)```/i),n=(r?r[1]:e).trim();n=n.replace(/^\s*\(\s*/,"").replace(/\s*\)\s*$/,"");try{let t=JSON.parse(n);if(t&&"object"==typeof t){let e={title:t.title,description:t.description,ageRange:t.ageRange,genre:t.genre,chapters:t.chapters,keypoints:t.keypoints,style:t.style};if(Object.values(e).some(t=>null!=t&&""!==t))return e}}catch(t){}let o=e.split(/\r?\n/).filter(Boolean);return o.length>=3&&o.slice(0,3).every(t=>/^(\s*(\d+[\).]|[•\-*])\s*)?/.test(t))?{toc:e}:{description:e}};if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.output))return{info:r(t.output)};if(t&&"object"==typeof t)return{info:t}}if("string"==typeof(null==e?void 0:e.output))return{info:r(e.output)};return{info:e}}catch(e){try{let e=(await m(c.prime,t)||"").toString().trim();return{info:e?{description:e}:{}}}catch(t){throw t}}}}},function(t){t.O(0,[295,888,774,179],function(){return t(t.s=9749)}),_N_E=t.O()}]);