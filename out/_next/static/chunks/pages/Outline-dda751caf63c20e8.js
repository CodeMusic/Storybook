(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{4349:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Outline",function(){return r(7563)}])},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});let n=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7326:function(e,t,r){"use strict";r.d(t,{T:function(){return a}});var n=r(5893);r(7294);var i=r(9346);function a(e){let{coverUrl:t,title:r}=e;return(0,n.jsxs)(i.Zb,{className:"bg-amber-50/80 border-amber-300 overflow-hidden",children:[t&&(0,n.jsx)("img",{src:t,alt:"Cover",className:"w-full aspect-[4/3] object-cover"}),(0,n.jsx)(i.Ol,{children:(0,n.jsx)(i.ll,{className:"text-amber-950",children:"Codex Core"})}),(0,n.jsxs)(i.aY,{className:"text-sm",children:[(0,n.jsx)("div",{className:"text-amber-900/70 uppercase text-xs",children:"Title"}),(0,n.jsx)("div",{className:"font-serif text-lg",children:r})]})]})}},9346:function(e,t,r){"use strict";r.d(t,{Ol:function(){return a},Zb:function(){return i},aY:function(){return o},ll:function(){return s}});var n=r(5893);r(7294);let i=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"rounded-2xl border bg-white ".concat(t),...r})},a=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"px-4 py-3 border-b ".concat(t),...r})},s=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"text-lg font-semibold ".concat(t),...r})},o=e=>{let{className:t="",...r}=e;return(0,n.jsx)("div",{className:"px-4 py-3 ".concat(t),...r})}},1207:function(e,t,r){"use strict";function n(e){let t=e.replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),r=[],n=1;function i(e,t){let i=e.replace(/^#{1,6}\s+/,"").trim(),a=(i=i.replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim())||"Chapter ".concat(n),s=(t||"").trim()||void 0;r.push({id:n++,heading:a,synopsis:s})}for(let e=0;e<t.length;e++){let r=t[e],n=r.match(/^\s*(?:\d+[\).]|[•\-*]|\d+\s+)\s*(.*)$/);if(n){let e=n[1].trim().split(/[—–\-:]\s+/);i((e[0]||"").replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim(),(e.slice(1).join(" - ")||"").trim());continue}let a=r.match(/^#{1,6}\s+(.*)$/);if(a){if(/table of contents/i.test(a[1]))continue;let r=t[e+1],n=r&&!/^#{1,6}\s+/.test(r)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(r);i(a[1],n?r:void 0),n&&e++;continue}let s=r.match(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*(.*)$/i);if(s){let r=t[e+1],n=r&&!/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i.test(r)&&!/^#{1,6}\s+/.test(r)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(r);i(s[1],n?r:void 0),n&&e++;continue}}return r}function i(e,t){let r=t.split(/\r?\n/).filter(Boolean).slice(0,2).join(", ");return"".concat(e,": ").concat(r,". Cozy watercolor, soft light, storybook composition, ancient relic/tech motif.")}r.d(t,{B:function(){return n},Z:function(){return i}})},7563:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return p}});var n=r(5893),i=r(7294),a=r(1163),s=r(1891);let o=(0,r(1134).Z)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);var l=r(3432),c=r(7326),u=r(1207),d=r(2743);function p(){let e=(0,a.useRouter)(),t="storyforge.session.v1",[r,p]=(0,i.useState)(""),[f,m]=(0,i.useState)(""),[h,g]=(0,i.useState)("6-8"),[y,x]=(0,i.useState)("fantasy"),[b,v]=(0,i.useState)(8),[S,w]=(0,i.useState)(""),[N,j]=(0,i.useState)("warm, whimsical, gentle-humor"),[C,E]=(0,i.useState)(null),[O,B]=(0,i.useState)(!0),[k,U]=(0,i.useState)(null),[T,J]=(0,i.useState)(null),[A,_]=(0,i.useState)([]),[I,R]=(0,i.useState)([]),[z,D]=(0,i.useState)(!1),[G,P]=(0,i.useState)(0),Z=(0,i.useRef)(!1);return(0,i.useEffect)(()=>{try{let r=window.localStorage.getItem(t);if(r){var e;let n=JSON.parse(r);if(n.premise&&n.premise.includes("Cannot access uninitialized variable")){console.log("DEBUG: Sanitizing corrupted premise in localStorage"),n.premise="";try{window.localStorage.setItem(t,JSON.stringify(n))}catch(e){}}p(null!==(e=n.title)&&void 0!==e?e:""),m(n.premise||""),g(n.ageRange||"6-8"),x(n.genre||"fantasy"),v("number"==typeof n.chaptersTarget?n.chaptersTarget:8),w(n.keypoints||""),j(n.style||"warm, whimsical, gentle-humor"),E(n.coverUrl||null),J(n.toc||null),_(Array.isArray(n.chapters)?n.chapters:[]);try{let e=(Array.isArray(n.scenes)?n.scenes:[]).map(e=>null==e?void 0:e.chapterId).filter(e=>"number"==typeof e);R(e)}catch(e){}}}catch(e){console.error("DEBUG Outline: localStorage error =",e)}finally{D(!0)}},[]),(0,i.useEffect)(()=>{(async()=>{try{if(console.log("DEBUG Outline useEffect: hydrated =",z,"toc =",T),!z)return;let e=JSON.stringify({title:r,premise:f,ageRange:h,genre:y,chaptersTarget:b,keypoints:S,style:N});try{let r=window.localStorage.getItem(t),n=r?JSON.parse(r):{};if(n.seedSignature!==e){let r={...n,seedSignature:e,toc:null,chapters:[]};try{window.localStorage.setItem(t,JSON.stringify(r))}catch(e){}J(null),_([])}}catch(e){}if(T&&0===G&&0===A.length){let e=(T||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,""),r=(0,u.B)(e);J(e),_(r);try{let n=window.localStorage.getItem(t),i={...n?JSON.parse(n):{},toc:e,chapters:r};window.localStorage.setItem(t,JSON.stringify(i))}catch(e){}return}if(T&&0===G||Z.current)return;let n="Cannot access uninitialized variable",i=r&&!r.includes(n)?r:"",a=f&&!f.includes(n)?f:"";if(console.log("DEBUG Outline: evaluating seed readiness. titleSafe =",i,"premiseSafe =",a),B(!0),U(null),Z.current=!0,!(i&&i.trim()||a&&a.trim())){console.log("DEBUG Outline: Missing title/premise after sanitize, setting error"),U("Missing seed info. Return and provide an idea or description."),B(!1);return}let s={title:i||"Untitled Codex",premise:a||i,prompt:a||i||"Untitled Codex",ageRange:h,genre:y,chapters:b,keypoints:S||void 0,style:N};console.log("DEBUG Outline: Sending payload to seedStory @",(null===d.bV||void 0===d.bV?void 0:d.bV.seed)||"n/a","payload =",s);let{toc:o}=await (0,d.Mq)(s);console.log("DEBUG: Received TOC:",o);let l=(o||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,"");J(l);let c=(0,u.B)(l);_(c);try{let e=window.localStorage.getItem(t),r={...e?JSON.parse(e):{},toc:l,chapters:c};window.localStorage.setItem(t,JSON.stringify(r))}catch(e){}}catch(e){U((null==e?void 0:e.message)||"Seeding outline failed")}finally{B(!1),Z.current=!1,G>0&&P(0)}})()},[z,G,r,f,h,y,b,S,N]),(0,n.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,n.jsx)("div",{className:"relative",children:(0,n.jsxs)("div",{className:"mx-auto max-w-6xl px-4 py-8",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)(s.E.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl bg-amber-200/70 p-2 shadow",children:(0,n.jsx)(o,{className:"h-6 w-6"})}),(0,n.jsx)(s.E.h1,{initial:{opacity:0,y:0},animate:{opacity:1,y:0},className:"text-2xl md:text-3xl font-serif tracking-wide",children:"Outline"})]}),(0,n.jsx)("p",{className:"mt-1 text-amber-900/80",children:r||"Untitled Codex"})]})}),(0,n.jsx)("main",{className:"relative mx-auto max-w-6xl px-4 pb-20",children:(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,n.jsx)("div",{className:"lg:col-span-1",children:(0,n.jsx)(c.T,{coverUrl:C,title:r||"Untitled Codex"})}),(0,n.jsxs)("div",{className:"lg:col-span-2",children:[(0,n.jsxs)("div",{className:"relative rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px]",children:[O&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,n.jsx)(l.Z,{className:"h-5 w-5 animate-spin"}),(0,n.jsx)("span",{children:"Engraving your table of contents…"})]})}),k&&(0,n.jsxs)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:[(0,n.jsx)("div",{children:k}),(0,n.jsx)("div",{className:"mt-2",children:(0,n.jsx)("button",{onClick:()=>P(e=>e+1),className:"rounded-lg bg-red-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]}),!O&&!k&&A.length>0&&(0,n.jsx)("ol",{className:"space-y-2",children:A.map(t=>{let i=I.includes(t.id);return(0,n.jsxs)("li",{className:"rounded-xl border p-3 cursor-pointer ".concat(i?"border-emerald-300 bg-emerald-50/60":"border-amber-200 bg-white/70"),onClick:()=>e.push({pathname:"/Read",query:{chapter:t.id,title:r||"Untitled Codex"}}),children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"font-serif font-semibold",children:[t.id,". ",t.heading]}),(0,n.jsx)("div",{className:"text-xs text-amber-900/70",children:i?"engraved":"tap to generate"})]}),t.synopsis&&(0,n.jsx)("div",{className:"text-sm text-amber-900/80",children:t.synopsis})]},t.id)})}),!O&&!k&&0===A.length&&(0,n.jsx)("div",{className:"text-amber-900/80",children:"No chapters detected. Please adjust your seed or retry."})]}),(0,n.jsx)("div",{className:"mt-4 flex justify-end gap-2",children:A.length>0&&I.length>=A.length&&(0,n.jsx)("button",{onClick:()=>e.push("/Read?export=1"),className:"inline-flex items-center justify-center rounded-xl bg-amber-600 text-white px-5 py-3 shadow hover:bg-amber-700",disabled:O,children:"Export Full Book"})})]})]})})]})}},2743:function(e,t,r){"use strict";r.d(t,{Mq:function(){return m},WF:function(){return x},Yl:function(){return h},bV:function(){return l},km:function(){return y},o9:function(){return b},tH:function(){return a}});var n=r(4406),i=r(8834).lW;let a="https://n8n.codemusic.ca/webhook",s=n.env.NEXT_PUBLIC_N8N_USER||"siteuser",o=n.env.NEXT_PUBLIC_N8N_PASS||"codemusai",l={prime:"".concat(a,"/seedInfo"),seed:"".concat(a,"/seedStory"),chapter:"".concat(a,"/expandChapter"),image:"".concat(a,"/genImage"),export:"".concat(a,"/exportBook")};function c(){let e="".concat(s,":").concat(o);try{let t="function"==typeof btoa?btoa(e):i.from(e).toString("base64");return"Basic ".concat(t)}catch(e){return""}}function u(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e5,n=new AbortController,i=setTimeout(()=>n.abort(),r);return fetch(e,{...t,signal:n.signal}).finally(()=>clearTimeout(i))}async function d(e,t){let r=await u(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(t)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));if(!n)throw Error("Empty response");return n}async function p(e,t){let r=await u(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(t)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));try{return JSON.parse(n)}catch(e){throw Error("Invalid JSON response")}}async function f(e,t){let r=await u(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(t)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));return n}async function m(e){console.log("DEBUG seedStory: endpoint =",l.seed),console.log("DEBUG seedStory: payload =",e);try{let t=await d(l.seed,e);console.log("DEBUG seedStory: raw response =",t);let r=function(e){let t=(e||"").toString().trim();if(!t)return t;try{let e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.toc))return t.toc;if("string"==typeof(null==t?void 0:t.output))return t.output}if("object"==typeof e&&e){if("string"==typeof e.toc)return e.toc;if("string"==typeof e.output)return e.output}}catch(e){}return t}(t);return console.log("DEBUG seedStory: parsed toc =",r),{toc:r}}catch(e){throw console.error("DEBUG seedStory: error =",e),e}}async function h(e){return{html:function e(t){let r=(t||"").toString().trim();if(!r)return"";try{let t=JSON.parse(r);if(Array.isArray(t)&&t.length>0){let r=t[0];if("string"==typeof(null==r?void 0:r.html))return r.html;if("string"==typeof(null==r?void 0:r.output))return e(r.output)}if("object"==typeof t&&t){if("string"==typeof t.html)return t.html;if("string"==typeof t.output)return e(t.output)}}catch(e){}return/[<][a-zA-Z!/?]/.test(r)?r:r.split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>{let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br/>");return"<p>".concat(t,"</p>")}).join("\n")}(await d(l.chapter,e))}}async function g(e,t){let r=await u(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(t)}),n=r.headers.get("content-type")||"";if(!r.ok)throw Error(await r.text().catch(()=>"")||"Endpoint error ".concat(r.status));if(n.startsWith("image/")){let e=await r.blob();return URL.createObjectURL(e)}let i=await r.text();try{let e=JSON.parse(i);if("string"==typeof(null==e?void 0:e.url))return e.url;if("string"==typeof(null==e?void 0:e.data)){let t=(null==e?void 0:e.mime)||(null==e?void 0:e.type)||"image/png";if(e.data.startsWith("data:"))return e.data;return"data:".concat(t,";base64,").concat(e.data)}}catch(e){}let a=i.trim();if(!a)throw Error("Empty response");return a}async function y(e){return{url:await g(l.image,{prompt:e})}}async function x(e){try{return{downloadUrl:await d(l.export,e)}}catch(e){return{downloadUrl:null}}}async function b(e){try{let t=await p(l.prime,e),r=e=>{let t=(e||"").trim(),r=t.match(/```\s*json\s*([\s\S]*?)```/i)||t.match(/```\s*([\s\S]*?)```/i),n=(r?r[1]:t).trim();n=n.replace(/^\s*\(\s*/,"").replace(/\s*\)\s*$/,"");try{let e=JSON.parse(n);if(e&&"object"==typeof e){let t={title:e.title,description:e.description,ageRange:e.ageRange,genre:e.genre,chapters:e.chapters,keypoints:e.keypoints,style:e.style};if(Object.values(t).some(e=>null!=e&&""!==e))return t}}catch(e){}let i=t.split(/\r?\n/).filter(Boolean);return i.length>=3&&i.slice(0,3).every(e=>/^(\s*(\d+[\).]|[•\-*])\s*)?/.test(e))?{toc:t}:{description:t}};if(Array.isArray(t)&&t.length>0){let e=t[0];if("string"==typeof(null==e?void 0:e.output))return{info:r(e.output)};if(e&&"object"==typeof e)return{info:e}}if("string"==typeof(null==t?void 0:t.output))return{info:r(t.output)};return{info:t}}catch(t){try{let t=(await f(l.prime,e)||"").toString().trim();return{info:t?{description:t}:{}}}catch(e){throw e}}}}},function(e){e.O(0,[295,891,888,774,179],function(){return e(e.s=4349)}),_N_E=e.O()}]);