(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(8254)}])},1134:function(e,t,r){"use strict";r.d(t,{Z:function(){return o}});var a=r(7294);let n=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),l=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()};var i={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let s=(0,a.forwardRef)((e,t)=>{let{color:r="currentColor",size:n=24,strokeWidth:s=2,absoluteStrokeWidth:o,className:c="",children:d,iconNode:u,...m}=e;return(0,a.createElement)("svg",{ref:t,...i,width:n,height:n,stroke:r,strokeWidth:o?24*Number(s)/Number(n):s,className:l("lucide",c),...m},[...u.map(e=>{let[t,r]=e;return(0,a.createElement)(t,r)}),...Array.isArray(d)?d:[d]])}),o=(e,t)=>{let r=(0,a.forwardRef)((r,i)=>{let{className:o,...c}=r;return(0,a.createElement)(s,{ref:i,iconNode:t,className:l("lucide-".concat(n(e)),o),...c})});return r.displayName="".concat(e),r}},2779:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]])},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},5062:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]])},8914:function(e,t,r){"use strict";function a(e){let t=[{label:"1-3",min:1,max:3},{label:"4-8",min:4,max:8},{label:"6-8",min:6,max:8},{label:"9-15",min:9,max:15},{label:"16-20",min:16,max:20},{label:"21-25",min:21,max:25},{label:"25+",min:25,max:Number.POSITIVE_INFINITY,isPlus:!0}];function r(e){if(isNaN(e)||e<=0)return"6-8";if(e>=25)return"25+";let r=null;for(let a of t){if(a.isPlus)continue;let t=Math.abs((a.min+a.max)/2-e);(!r||t<r.distance)&&(r={label:a.label,distance:t})}return r?r.label:"6-8"}if(!e||"string"!=typeof e)return"6-8";let a=e.toString().trim();if(!a)return"6-8";if(t.some(e=>e.label===a))return a;let n=a.toLowerCase();if(/(toddler|infant|baby)/.test(n))return"1-3";if(/(kid|child|children|elementary|grade school)/.test(n))return"6-8";if(/(teen|pre-?teen|middle school)/.test(n))return"16-20";if(/(adult|grown|mature)/.test(n))return"21-25";let l=n.match(/\b(\d{1,3})\s*\+\b/);if(l){let e=parseInt(l[1],10);if(!isNaN(e))return e>=25?"25+":r(e)}let i=n.match(/\b(\d{1,3})\s*(?:[-–—]|to|through|–)\s*(\d{1,3})\b/);if(i){let e=parseInt(i[1],10),t=parseInt(i[2],10);if(!isNaN(e)&&!isNaN(t))return function(e,t){let a=Math.min(e,t),n=Math.max(e,t);return isNaN(a)||isNaN(n)||a<=0?"6-8":n>=25?"25+":r((a+n)/2)}(e,t)}let s=n.match(/\b(\d{1,3})\b/);if(s){let e=parseInt(s[1],10);if(!isNaN(e))return r(e)}return"6-8"}function n(e){let t=a(e);if(/^\d{1,3}\+$/.test(t)){let e=parseInt(t.replace(/\D/g,""),10);return{ageMin:isNaN(e)?void 0:e,ageMax:void 0}}let r=t.match(/^(\d{1,3})-(\d{1,3})$/);if(r){let e=parseInt(r[1],10),t=parseInt(r[2],10);return{ageMin:isNaN(e)?void 0:e,ageMax:isNaN(t)?void 0:t}}return{}}function l(e){let{ageMin:t,ageMax:r}=n(e);return function(e,t){if(void 0!==e&&void 0!==t){if(t<=3)return{range:[50,150],label:"1–3"};if(e>=4&&t<=8)return{range:[500,1e3],label:"4–8"};if(e>=9&&t<=15)return{range:[1500,3e3],label:"9–15"};if(e>=16&&t<=20)return{range:[2500,4e3],label:"16–20"};if(e>=21&&t<=25)return{range:[3e3,5e3],label:"21–25"};if(e>=26||t>=26)return{range:[3e3,6e3],label:"25+"}}return{range:[3e3,5e3],label:"default-adult"}}(t,r)}function i(e){let{ageMin:t,ageMax:r}=n(e);return void 0!==r&&r<=3?"prose-xl md:prose-2xl":"prose-lg md:prose-xl"}function s(e){let{ageMin:t,ageMax:r}=n(e);return void 0!==r&&r<=3?"text-2xl md:text-3xl":"text-xl md:text-2xl"}r.d(t,{BU:function(){return l},FY:function(){return i},RH:function(){return a},VV:function(){return s}})},8254:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return p}});var a=r(5893),n=r(7294),l=r(1163),i=r(1134);let s=(0,i.Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var o=r(3432);let c=(0,i.Z)("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]);var d=r(5062),u=r(2779),m=r(2743),h=r(8914);function p(){var e,t,r,i;let p=(0,l.useRouter)(),f="storyforge.session.v1",g="string"==typeof(null===(e=p.query)||void 0===e?void 0:e.chapter)?parseInt(p.query.chapter,10):void 0,b=(null===(t=p.query)||void 0===t?void 0:t.export)==="1"||(null===(r=p.query)||void 0===r?void 0:r.export)==="true",[x,y]=(0,n.useState)(""),[w,v]=(0,n.useState)(null),[N,j]=(0,n.useState)([]),[k,S]=(0,n.useState)(null),[C,I]=(0,n.useState)([]),[_,P]=(0,n.useState)(!1),[E,R]=(0,n.useState)(null),[U,A]=(0,n.useState)((0,h.RH)("6-8")),[M,O]=(0,n.useState)("fantasy"),[L,Z]=(0,n.useState)("short"),[$,F]=(0,n.useState)(""),[W,H]=(0,n.useState)("warm, whimsical, gentle-humor"),[q,T]=(0,n.useState)(""),z=(0,h.FY)(U),B=(0,h.VV)(U),[J,D]=(0,n.useState)(!1),[V,Y]=(0,n.useState)(""),[X,G]=(0,n.useState)(""),[K,Q]=(0,n.useState)(null),[ee,et]=(0,n.useState)(null),[er,ea]=(0,n.useState)(""),[en,el]=(0,n.useState)(!1),ei="storyforge.streaming.v1",es=(0,n.useRef)({}),[eo,ec]=(0,n.useState)(null),[ed,eu]=(0,n.useState)(null),[em,eh]=(0,n.useState)(!1),[ep,ef]=(0,n.useState)(!1),[eg,eb]=(0,n.useState)(!1),[ex,ey]=(0,n.useState)(null),[ew,ev]=(0,n.useState)(!1),[eN,ej]=(0,n.useState)(!1),[ek,eS]=(0,n.useState)(!1),eC=(0,n.useRef)(null);function eI(e){return e&&e.trim()?e.replace(/^\s*((?:<div[^>]*class="[^"]*words-flash[^"]*"[^>]*>\s*)?)(<h[1-6][^>]*>[\s\S]*?<\/h[1-6]>\s*)/i,(e,t)=>"".concat(t)):e}function e_(e){if(!e||!e.trim())return e;let t=e.replace(/^\s*((?:<div[^>]*class="[^"]*words-flash[^"]*"[^>]*>\s*)?(?:<p[^>]*>\s*)?)\s*Chapter\s+[^:]{1,80}:\s*/i,(e,t)=>"".concat(t));return t!==e?t:e.replace(/^\s*Chapter\s+[^:]{1,80}:\s*/i,"")}function eP(e){let t=eE((e||"").toString());return t.trim()?/[<][a-zA-Z!\/?]/.test(t)?e_(eI(eU(t))):e_(eI(function(e){let t=eE(e||"");if(!t.trim())return"";let r=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/^######\s+(.*)$/gm,"<h6>$1</h6>")).replace(/^#####\s+(.*)$/gm,"<h5>$1</h5>")).replace(/^####\s+(.*)$/gm,"<h4>$1</h4>")).replace(/^###\s+(.*)$/gm,"<h3>$1</h3>")).replace(/^##\s+(.*)$/gm,"<h2>$1</h2>")).replace(/^#\s+(.*)$/gm,"<h1>$1</h1>")).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/(^|[^_])_([^_\n][^_]*)_/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).replace(/(^|[^*])\*([^*\n][^*]*)\*/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>/^<h[1-6]>/.test(e)?e:"<p>".concat(e.replace(/\n/g,"<br/>"),"</p>")).join("\n")}(t))):""}function eE(e){if(!e)return e;let t=e.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");return(t=t.replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(parseInt(t,10)))).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}function eR(e,t,r){if(!e||!e.trim())return e;let a=e.split(/(<[^>]+>)/g),n=0,l=!1,i=Math.max(0,0|t),s=a.map(e=>e.startsWith("<")?e:e.replace(/([\w'’]+)(\s*)/g,(e,t,a)=>(n++,!l&&(null==r?void 0:r.skipFirstWord))?(l=!0,"".concat(t).concat(a)):'<span class="'.concat("word",'">').concat(t,"</span>").concat(a))).join("");if(i<=0)return s;let o=Array.from(s.matchAll(/<span class=\"word\">([\s\S]*?)<\/span>/g));if(0===o.length)return s;let c=o.length-1,d=Math.max(0,c-i+1),u=s;for(let e=c;e>=d;e--){let t=o[e];if(!t)continue;let r=t[0],a=t[1],n=e===c?"word word-new":"word word-recent",l='<span class="'.concat(n,'">').concat(a,"</span>"),i=u.lastIndexOf(r);i>=0&&(u=u.slice(0,i)+l+u.slice(i+r.length))}return u}function eU(e){let t=(e||"").toString().trim();if(!t)return"";try{let e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.html))return t.html;if("string"==typeof(null==t?void 0:t.output))return eU(t.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return eU(e.output)}}catch(e){}if(/[<][a-zA-Z!\/?]/.test(t))return eE(t);let r=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return eE(t).split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>"<p>".concat(r(e).replace(/\n/g,"<br/>"),"</p>")).join("\n")}(0,n.useEffect)(()=>{let e=()=>{if(en){try{p.events.emit("routeChangeError")}catch(e){}throw"Route change aborted: streaming in progress"}},t=e=>{en&&(e.preventDefault(),e.returnValue="")};return p.events.on("routeChangeStart",e),window.addEventListener("beforeunload",t),()=>{p.events.off("routeChangeStart",e),window.removeEventListener("beforeunload",t)}},[en,p.events]),(0,n.useEffect)(()=>{try{let e=window.localStorage.getItem(ei);if(!e)return;let t=JSON.parse(e);t&&"number"==typeof t.chapterId&&!C.some(e=>e.chapterId===t.chapterId)&&(el(!0),et(t.chapterId),ea(t.chapterHeading||""),Q(t.imageUrl||null),G(eP(t.rawText||"")),P(!1))}catch(e){}},[]),(0,n.useEffect)(()=>{try{let t=window.localStorage.getItem(f);if(t){var e;let r=JSON.parse(t);y(null!==(e=r.title)&&void 0!==e?e:""),v(r.toc||null),j(Array.isArray(r.chapters)?r.chapters:[]),S(r.coverUrl||null),A((0,h.RH)(r.ageRange||"6-8")),O(r.genre||"fantasy"),Z(r.chapterLength||"short"),F(r.keypoints||""),H(r.style||"warm, whimsical, gentle-humor"),T(r.premise||"");let a=(Array.isArray(r.scenes)?r.scenes:[]).map(e=>({...e,html:eU((null==e?void 0:e.html)||"")}));I(a);try{let e={...r,scenes:a};window.localStorage.setItem(f,JSON.stringify(e))}catch(e){}}}catch(e){}D(!0)},[]),(0,n.useEffect)(()=>{var e;let t="string"==typeof(null===(e=p.query)||void 0===e?void 0:e.title)?p.query.title:"";!x&&t&&t.trim()&&y(t)},[null===(i=p.query)||void 0===i?void 0:i.title,x]),(0,n.useEffect)(()=>{(async()=>{if(b&&J&&Array.isArray(C)&&C.length>0)try{P(!0);let{downloadUrl:e,filename:t}=await (0,m.WF)({scenes:C,coverUrl:k,meta:{title:x,toc:w,chapters:N}});if(e){let r=document.createElement("a");r.href=e,r.download=t||"".concat(x||"storybook",".html"),document.body.appendChild(r),r.click(),r.remove(),e.startsWith("blob:")&&URL.revokeObjectURL(e)}}catch(e){R(e.message||"Export failed")}finally{P(!1)}})()},[b,J,C.length]);let eA=(0,n.useMemo)(()=>{if("number"==typeof g&&!isNaN(g)){let e=N.findIndex(e=>e.id===g);return e>=0?e:0}return Math.min(C.length,Math.max(0,(N.length,0)))},[g,N,C.length]);async function eM(){if(!N.length)return;let e=N[eA];if(e&&!C.some(t=>t.chapterId===e.id))try{P(!0),R(null);let t=(0,h.RH)(U),r=(0,h.BU)(t),a={title:x,premise:q,toc:w,priorHtml:C.map(e=>e.html),ageRange:t,lengthHint:r,genre:M,keypoints:$,style:W,chapterLength:L},n="[context: genre=".concat(M,"; age=").concat(t,"; style=").concat(W,"; notes=").concat(($||"").slice(0,120),"]");el(!0),et(e.id),ea(e.heading),G(""),Q(null);let l=null;try{let r="".concat(x||"Untitled Codex"," (ages ").concat(t,"): Chapter ").concat(e.id," - ").concat(e.heading,". Genre ").concat(M,". Style ").concat(W,"."),a=await (0,m.km)(r),n=(null==a?void 0:a.url)||null;if(n){l=n,Q(n);let e=()=>new Promise(e=>{try{let t=new Image;try{t.decoding="async"}catch(e){}try{t.loading="eager"}catch(e){}t.onload=()=>e(),t.onerror=()=>e(),t.src=n}catch(t){e()}}),t=async()=>{await e(),await new Promise(e=>setTimeout(e,200)),await e()};await Promise.race([t(),new Promise(e=>setTimeout(e,2500))]);try{if("undefined"!=typeof document){let e=document.createElement("link");e.rel="preload",e.as="image",e.href=n,document.head.appendChild(e),setTimeout(()=>{try{document.head.removeChild(e)}catch(e){}},15e3)}}catch(e){}}}catch(e){l=null}let i="",s=!1,o=0,c=V&&V.trim()?"".concat(n," ").concat(V.trim()):n;for await(let t of(0,m.nq)({context:a,chapterIndex:eA,influence:c,lengthHint:r})){i+=function(e){if(!e)return e;let t=eE(e);t=t.replace(/^\s*Scene\b[\s:]*/i,"");for(let e=0;e<3;e++){let e=t.match(/\{[\s\S]*?\}/);if(!e)break;try{let r=JSON.parse(e[0]);if(r&&"object"==typeof r&&"name"in r&&"parameters"in r){t=t.slice(0,e.index||0)+t.slice((e.index||0)+e[0].length);continue}}catch(e){}break}return t}(t),!s&&t&&t.trim()&&(P(!1),s=!0);let r=eP(i),a=r.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),n=a?a.split(" ").length:0,l=Math.max(0,n-o),c=eR(r,l,{skipFirstWord:!1});o=n,G(c);try{{let t={chapterId:e.id,chapterHeading:e.heading,rawText:i,imageUrl:K};window.localStorage.setItem(ei,JSON.stringify(t))}}catch(e){}}let d=(()=>{let e=eP(i);return'<div class="words-flash">'.concat(eR(e,0,{skipFirstWord:!1}),"</div>")})(),u=l||K,p=[...C,{chapterId:e.id,chapterHeading:e.heading,html:d,imageUrl:u}];I(p);try{let e=window.localStorage.getItem(f),t={...e?JSON.parse(e):{},scenes:p};window.localStorage.setItem(f,JSON.stringify(t))}catch(e){}try{window.localStorage.removeItem(ei)}catch(e){}}catch(e){R(e.message||"Chapter failed")}finally{el(!1),et(null),ea(""),G(""),_&&P(!1);try{Y("")}catch(e){}}}(0,n.useEffect)(()=>{eM()},[eA,N.length]);let eO=(0,n.useMemo)(()=>{if("number"==typeof g&&!isNaN(g)){let e=C.find(e=>e.chapterId===g);if(e)return e}return C[eA]},[C,eA,g]),eL=(0,n.useMemo)(()=>{if(!N.length)return;let e=Math.max(0,eA-1);if(e!==eA)return N[e]},[N,eA]),eZ=(0,n.useMemo)(()=>{if(!N.length)return;let e=Math.min(N.length-1,eA+1);if(e!==eA)return N[e]},[N,eA]),e$=(0,n.useMemo)(()=>en?X:(null==eO?void 0:eO.html)?eO.html:"",[null==eO?void 0:eO.html,en,X]),eF=(0,n.useMemo)(()=>{let e=function(e){if(!e||!e.trim())return null;let t=e.toString(),r=t.match(/^\s*(?:<div[^>]*class="[^"]*words-flash[^"]*"[^>]*>\s*)?(?:<h[1-6][^>]*>|<p[^>]*>)\s*Chapter\s+[^:]{1,80}:\s*([^<\n]{1,160})/i);if(r&&r[1])return r[1].trim();let a=t.match(/^\s*Chapter\s+[^:]{1,80}:\s*([^\n<]{1,160})/i);return a&&a[1]?a[1].trim():null}(en?X:(null==eO?void 0:eO.html)||""),t=eO?eO.chapterHeading:er;return e&&e.trim()?e.trim():((t||"").trim().toLowerCase().startsWith("chapter "),t||"")},[eO,er,en,X]),[eW,eH]=(0,n.useState)(!1);async function eq(e){let t=eC.current;if(ev(!1),eb(!1),t){try{t.pause()}catch(e){}try{t.removeAttribute("src")}catch(e){}try{t.load()}catch(e){}if(!eO||!eO.html){ec(null);return}try{ef(!0);let r=(eO.html||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),{url:a}=await (0,m.vz)(r);ec(a),t.src=a;let n=async()=>{if(ev(!0),e||eN)try{await t.play(),eh(!0),eb(!1),ej(!1)}catch(e){eb(!0)}};t.addEventListener("canplaythrough",n,{once:!0});try{t.load()}catch(e){}}catch(e){R((null==e?void 0:e.message)||"Audio failed")}finally{ef(!1)}}}async function eT(){ep||(eS(!0),ej(!0),await eq(!0))}async function ez(){try{if(!eO||!eO.html)return;if(!ek){await eT();return}if(ep&&ed){ej(!0);return}try{let e=window.AudioContext||window.webkitAudioContext;if(e){let t=ex||new e;ey(t),"running"!==t.state&&await t.resume().catch(()=>{})}}catch(e){}if(ed){if(em)ed.pause(),eh(!1);else if(ew)try{await ed.play(),eh(!0),eb(!1)}catch(e){eb(!0)}else{ej(!0);try{await ed.play(),eh(!0),eb(!1)}catch(e){eb(!0)}}return}if(eC.current){eu(eC.current),ej(!0);try{await eC.current.play(),eh(!0),eb(!1)}catch(e){eb(!0),eh(!1)}}}catch(e){R((null==e?void 0:e.message)||"Audio failed")}}async function eB(){try{if(!eo)return;let e=(x||"Storyforge").toString().replace(/[^a-z0-9\- _\(\)\[\]]+/gi,"_").trim()||"storybook",t=(eO?eO.chapterId:ee)||1,r="".concat(e,"-chapter-").concat(t,".mp3");if(eo.startsWith("blob:")||eo.startsWith("data:")){let e=document.createElement("a");e.href=eo,e.download=r,document.body.appendChild(e),e.click(),e.remove();return}try{let e=await fetch(eo),t=await e.blob(),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=r,document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>{try{URL.revokeObjectURL(a)}catch(e){}},15e3);return}catch(e){window.open(eo,"_blank")}}catch(e){}}async function eJ(e){try{eH(!0),await new Promise(e=>setTimeout(e,460))}finally{eH(!1),p.push({pathname:"/Read",query:e})}}return(0,n.useEffect)(()=>{let e=eC.current;if(e){try{e.crossOrigin="anonymous"}catch(e){}try{e.setAttribute("playsinline",""),e.setAttribute("webkit-playsinline","")}catch(e){}e.preload="auto",e.onended=()=>eh(!1),eu(e)}},[]),(0,n.useEffect)(()=>()=>{try{ed&&ed.pause()}catch(e){}try{eo&&eo.startsWith("blob:")&&URL.revokeObjectURL(eo)}catch(e){}eu(null),ec(null),eh(!1),ev(!1),ej(!1),eS(!1)},[eA]),(0,a.jsxs)("div",{className:"min-h-screen text-amber-950 font-story-body ".concat(eW?"is-turning":""," page-turning"),children:[(0,a.jsx)("header",{className:"relative",children:(0,a.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,a.jsxs)("button",{onClick:()=>p.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,a.jsx)(s,{className:"h-4 w-4"})," Back to outline"]}),(0,a.jsx)("h1",{className:"mt-2 text-2xl font-story-title whitespace-normal break-words",children:x||"StoryForge"})]})}),(0,a.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative page",children:[_&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,a.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}),(0,a.jsx)("span",{children:"Engraving chapter…"})]})}),E&&(0,a.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:E}),(eO||en)&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-story-title ".concat(B," mb-2 text-amber-900 whitespace-normal break-words"),children:eF&&!/^\s*chapter\s+/i.test(eF)?(0,a.jsxs)(a.Fragment,{children:["Chapter ",eO?eO.chapterId:ee,": ",eF]}):(0,a.jsx)(a.Fragment,{children:eF||"Chapter ".concat(eO?eO.chapterId:ee)})}),((null==eO?void 0:eO.imageUrl)||K)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("img",{src:(null==eO?void 0:eO.imageUrl)||K,alt:"Scene",loading:"eager",decoding:"async",fetchPriority:"high",className:"w-full h-auto rounded-lg border border-amber-200 mb-2",onError:async()=>{try{let e=eO?eO.chapterId:ee||0;if(!m.dY||!e||es.current[e])return;es.current[e]=!0;let t="".concat(x||"Untitled Codex"," (ages ").concat((0,h.RH)(U),"): Chapter ").concat(e," - ").concat((eO?eO.chapterHeading:er)||"","."),r=await (0,m.km)(t),a=(null==r?void 0:r.url)||null;eO?I(t=>t.map(t=>t.chapterId===e?{...t,imageUrl:a}:t)):Q(a)}catch(e){}}}),!!eZ&&!en&&(0,a.jsxs)("div",{className:"mb-3 max-w-md",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-amber-900 mb-1",children:"Influence (optional)"}),(0,a.jsx)("textarea",{value:V,onChange:e=>Y(e.target.value),rows:3,placeholder:"Suggest beats, tone, or details to prime the next chapter",className:"w-full rounded-lg border border-amber-200 bg-white/70 backdrop-blur px-3 py-2 text-sm text-amber-900 placeholder:text-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-300"}),(0,a.jsx)("div",{className:"text-[11px] text-amber-700 mt-1",children:"Used to guide the next chapter. Cleared after use."})]}),!!eO&&!en&&(0,a.jsxs)("div",{className:"flex justify-end mb-3",children:[(0,a.jsxs)("button",{onClick:ek?ez:eT,disabled:ep||en||!(null==eO?void 0:eO.html),title:!en&&(null==eO?void 0:eO.html)?ep?"Preparing…":ek?em?"Pause narration":"Play narration":"Speak narration":"Waiting for generation…",className:"inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 hover:bg-amber-100 shadow-sm disabled:opacity-60 disabled:cursor-not-allowed","aria-label":ek?em?"Pause narration":"Play narration":"Speak narration",children:[(0,a.jsxs)("span",{className:"relative inline-flex h-4 w-4 items-center justify-center",children:[ep&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"absolute -inset-1 rounded-full bg-amber-400/50 blur-md animate-ping","aria-hidden":"true"}),(0,a.jsx)("span",{className:"absolute inset-0 rounded-full bg-amber-500/40 blur-sm animate-pulse","aria-hidden":"true"})]}),em?(0,a.jsx)(c,{className:"h-4 w-4 relative ".concat(ep?"drop-shadow-[0_0_6px_rgba(245,158,11,0.9)]":"")}):(0,a.jsx)(d.Z,{className:"h-4 w-4 relative ".concat(ep?"drop-shadow-[0_0_6px_rgba(245,158,11,0.9)]":"")})]}),(0,a.jsx)("span",{className:"text-xs",children:ek?em?"Pause":ep?"Preparing…":"Play":ep?"Preparing…":"Speak"})]}),eo&&(0,a.jsxs)("button",{onClick:eB,disabled:ep,className:"ml-2 inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 hover:bg-amber-100 shadow-sm","aria-label":"Download narration audio",children:[(0,a.jsx)(u.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"text-xs",children:"Download"})]})]})]}),!(null==eO?void 0:eO.imageUrl)&&!!eO&&!en&&(0,a.jsxs)(a.Fragment,{children:[!!eZ&&(0,a.jsxs)("div",{className:"mb-3 max-w-md",children:[(0,a.jsx)("label",{className:"block text-xs font-medium text-amber-900 mb-1",children:"Influence (optional)"}),(0,a.jsx)("textarea",{value:V,onChange:e=>Y(e.target.value),rows:3,placeholder:"Suggest beats, tone, or details to prime the next chapter",className:"w-full rounded-lg border border-amber-200 bg-white/70 backdrop-blur px-3 py-2 text-sm text-amber-900 placeholder:text-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-300"}),(0,a.jsx)("div",{className:"text-[11px] text-amber-700 mt-1",children:"Used to guide the next chapter. Cleared after use."})]}),(0,a.jsxs)("div",{className:"flex justify-end mb-3",children:[(0,a.jsxs)("button",{onClick:ek?ez:eT,disabled:ep||en||!(null==eO?void 0:eO.html),title:!en&&(null==eO?void 0:eO.html)?ep?"Preparing…":ek?em?"Pause narration":"Play narration":"Speak narration":"Waiting for generation…",className:"inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 hover:bg-amber-100 shadow-sm disabled:opacity-60 disabled:cursor-not-allowed","aria-label":ek?em?"Pause narration":"Play narration":"Speak narration",children:[(0,a.jsxs)("span",{className:"relative inline-flex h-4 w-4 items-center justify-center",children:[ep&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"absolute -inset-1 rounded-full bg-amber-400/50 blur-md animate-ping","aria-hidden":"true"}),(0,a.jsx)("span",{className:"absolute inset-0 rounded-full bg-amber-500/40 blur-sm animate-pulse","aria-hidden":"true"})]}),em?(0,a.jsx)(c,{className:"h-4 w-4 relative ".concat(ep?"drop-shadow-[0_0_6px_rgba(245,158,11,0.9)]":"")}):(0,a.jsx)(d.Z,{className:"h-4 w-4 relative ".concat(ep?"drop-shadow-[0_0_6px_rgba(245,158,11,0.9)]":"")})]}),(0,a.jsx)("span",{className:"text-xs",children:ek?em?"Pause":ep?"Preparing…":"Play":ep?"Preparing…":"Speak"})]}),eo&&(0,a.jsxs)("button",{onClick:eB,disabled:ep,className:"ml-2 inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 hover:bg-amber-100 shadow-sm","aria-label":"Download narration audio",children:[(0,a.jsx)(u.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"text-xs",children:"Download"})]})]})]}),en&&(0,a.jsx)("div",{className:"flex justify-end mb-3",children:(0,a.jsxs)("button",{disabled:!0,title:"Waiting for generation…",className:"inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 shadow-sm opacity-60 cursor-not-allowed","aria-label":"Speak narration (disabled during generation)",children:[(0,a.jsx)("span",{className:"relative inline-flex h-4 w-4 items-center justify-center",children:(0,a.jsx)(d.Z,{className:"h-4 w-4"})}),(0,a.jsx)("span",{className:"text-xs",children:"Speak"})]})}),(0,a.jsx)("div",{className:"".concat(z," prose-amber prose-story dropcap font-story-body max-w-none ").concat(en?"story-hit":""),dangerouslySetInnerHTML:{__html:e_(eI(e$))}})]})]})}),(0,a.jsx)("audio",{ref:eC,style:{display:"none"}}),!_&&(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,a.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,a.jsx)("button",{onClick:()=>p.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>{eL&&eJ({chapter:eL.id,title:x||"Untitled Codex"})},disabled:!eL,className:"rounded-xl border px-4 py-2 text-sm ".concat(eL?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:eL?"Previous: Chapter ".concat(eL.id):"Previous"}),N.length>0&&C.length>=N.length?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>p.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,a.jsx)("button",{onClick:()=>p.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,a.jsx)("button",{onClick:()=>{eZ&&eJ({chapter:eZ.id,title:x||"Untitled Codex"})},disabled:!eZ,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(eZ?"":"opacity-50 cursor-not-allowed"),children:eZ?"Next: Chapter ".concat(eZ.id):"Next"})]})]})})})]})}}},function(e){e.O(0,[154,743,888,774,179],function(){return e(e.s=9749)}),_N_E=e.O()}]);