(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(7154)}])},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7154:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return d}});var a=r(5893),n=r(7294),l=r(1163);let s=(0,r(1134).Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var i=r(3432),o=r(2743),c=r(8914);function d(){var e,t,r,d;let u=(0,l.useRouter)(),m="storyforge.session.v1",h="string"==typeof(null===(e=u.query)||void 0===e?void 0:e.chapter)?parseInt(u.query.chapter,10):void 0,p=(null===(t=u.query)||void 0===t?void 0:t.export)==="1"||(null===(r=u.query)||void 0===r?void 0:r.export)==="true",[x,f]=(0,n.useState)(""),[g,b]=(0,n.useState)(null),[y,v]=(0,n.useState)([]),[N,w]=(0,n.useState)(null),[j,k]=(0,n.useState)([]),[S,C]=(0,n.useState)(!1),[R,_]=(0,n.useState)(null),[E,I]=(0,n.useState)((0,c.RH)("6-8")),[M,O]=(0,n.useState)("fantasy"),[q,U]=(0,n.useState)(""),[H,A]=(0,n.useState)("warm, whimsical, gentle-humor"),B=(0,c.FY)(E),J=(0,c.VV)(E);(0,n.useEffect)(()=>{try{let t=window.localStorage.getItem(m);if(t){var e;let r=JSON.parse(t);f(null!==(e=r.title)&&void 0!==e?e:""),b(r.toc||null),v(Array.isArray(r.chapters)?r.chapters:[]),w(r.coverUrl||null),I((0,c.RH)(r.ageRange||"6-8")),O(r.genre||"fantasy"),U(r.keypoints||""),A(r.style||"warm, whimsical, gentle-humor");let a=(Array.isArray(r.scenes)?r.scenes:[]).map(e=>({...e,html:function e(t){let r=(t||"").toString().trim();if(!r)return"";try{let t=JSON.parse(r);if(Array.isArray(t)&&t.length>0){let r=t[0];if("string"==typeof(null==r?void 0:r.html))return r.html;if("string"==typeof(null==r?void 0:r.output))return e(r.output)}if("object"==typeof t&&t){if("string"==typeof t.html)return t.html;if("string"==typeof t.output)return e(t.output)}}catch(e){}if(/[<][a-zA-Z!/?]/.test(r))return r;let a=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return r.split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>"<p>".concat(a(e).replace(/\n/g,"<br/>"),"</p>")).join("\n")}((null==e?void 0:e.html)||"")}));k(a);try{let e={...r,scenes:a};window.localStorage.setItem(m,JSON.stringify(e))}catch(e){}}}catch(e){}},[]),(0,n.useEffect)(()=>{var e;let t="string"==typeof(null===(e=u.query)||void 0===e?void 0:e.title)?u.query.title:"";!x&&t&&t.trim()&&f(t)},[null===(d=u.query)||void 0===d?void 0:d.title,x]),(0,n.useEffect)(()=>{(async()=>{if(p)try{C(!0);let{downloadUrl:e,filename:t}=await (0,o.WF)({scenes:j,coverUrl:N,meta:{title:x,toc:g,chapters:y}});if(e){let r=document.createElement("a");r.href=e,r.download=t||"".concat(x||"storybook",".html"),document.body.appendChild(r),r.click(),r.remove(),e.startsWith("blob:")&&URL.revokeObjectURL(e)}}catch(e){_(e.message||"Export failed")}finally{C(!1)}})()},[p]);let L=(0,n.useMemo)(()=>{if("number"==typeof h&&!isNaN(h)){let e=y.findIndex(e=>e.id===h);return e>=0?e:0}return Math.min(j.length,Math.max(0,(y.length,0)))},[h,y,j.length]);async function Z(){if(!y.length)return;let e=y[L];if(e&&!j.some(t=>t.chapterId===e.id))try{C(!0),_(null);let t=(0,c.RH)(E),r=(0,c.BU)(t),a={title:x,toc:g,priorHtml:j.map(e=>e.html),ageRange:t,lengthHint:r,genre:M,keypoints:q,style:H},n="[context: genre=".concat(M,"; age=").concat(t,"; style=").concat(H,"; notes=").concat((q||"").slice(0,120),"]"),{html:l}=await (0,o.Yl)({context:a,chapterIndex:L,influence:n}),s=null;try{s=(await (0,o.km)("".concat(x," (ages ").concat((0,c.RH)(E),"): ").concat(e.heading,". ").concat(l.slice(0,180),"..."))).url}catch(e){}let i=[...j,{chapterId:e.id,chapterHeading:e.heading,html:l,imageUrl:s}];k(i);try{let e=window.localStorage.getItem(m),t={...e?JSON.parse(e):{},scenes:i};window.localStorage.setItem(m,JSON.stringify(t))}catch(e){}}catch(e){_(e.message||"Chapter failed")}finally{C(!1)}}(0,n.useEffect)(()=>{Z()},[L,y.length]);let P=(0,n.useMemo)(()=>{if("number"==typeof h&&!isNaN(h)){let e=j.find(e=>e.chapterId===h);if(e)return e}return j[L]},[j,L,h]),z=(0,n.useMemo)(()=>{if(!y.length)return;let e=Math.max(0,L-1);if(e!==L)return y[e]},[y,L]),F=(0,n.useMemo)(()=>{if(!y.length)return;let e=Math.min(y.length-1,L+1);if(e!==L)return y[e]},[y,L]);return(0,a.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,a.jsx)("header",{className:"relative",children:(0,a.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,a.jsxs)("button",{onClick:()=>u.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,a.jsx)(s,{className:"h-4 w-4"})," Back to outline"]}),(0,a.jsx)("h1",{className:"mt-2 text-2xl font-serif",children:x||"Untitled Codex"})]})}),(0,a.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative",children:[S&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,a.jsx)(i.Z,{className:"h-5 w-5 animate-spin"}),(0,a.jsx)("span",{children:"Engraving chapterâ€¦"})]})}),R&&(0,a.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:R}),P&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-serif ".concat(J," mb-2"),children:["Chapter ",P.chapterId,": ",P.chapterHeading]}),P.imageUrl&&(0,a.jsx)("img",{src:P.imageUrl,alt:"Scene",className:"w-full h-auto rounded-lg border border-amber-200 mb-3"}),(0,a.jsx)("div",{className:"".concat(B," prose-amber max-w-none"),dangerouslySetInnerHTML:{__html:P.html}})]})]})}),!S&&(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,a.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,a.jsx)("button",{onClick:()=>u.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>{z&&u.push({pathname:"/Read",query:{chapter:z.id,title:x||"Untitled Codex"}})},disabled:!z,className:"rounded-xl border px-4 py-2 text-sm ".concat(z?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:z?"Previous: Chapter ".concat(z.id):"Previous"}),y.length>0&&j.length>=y.length?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>u.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,a.jsx)("button",{onClick:()=>u.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,a.jsx)("button",{onClick:()=>{F&&u.push({pathname:"/Read",query:{chapter:F.id,title:x||"Untitled Codex"}})},disabled:!F,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(F?"":"opacity-50 cursor-not-allowed"),children:F?"Next: Chapter ".concat(F.id):"Next"})]})]})})})]})}}},function(e){e.O(0,[295,379,888,774,179],function(){return e(e.s=9749)}),_N_E=e.O()}]);