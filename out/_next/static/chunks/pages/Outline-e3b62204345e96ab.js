(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{4349:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Outline",function(){return n(7563)}])},3432:function(e,t,n){"use strict";n.d(t,{Z:function(){return r}});let r=(0,n(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7326:function(e,t,n){"use strict";n.d(t,{T:function(){return l}});var r=n(5893),i=n(7294),a=n(9346);function l(e){let{coverUrl:t,title:n,onBroken:l}=e,[s,o]=(0,i.useState)(!1);return(0,r.jsxs)(a.Zb,{className:"bg-amber-50/80 border-amber-300 overflow-hidden",children:[t&&(0,r.jsx)("img",{src:t,alt:"Cover",className:"w-full aspect-[4/3] object-cover",onError:function(){if(!s){o(!0);try{l&&l()}catch(e){}}}}),(0,r.jsx)(a.Ol,{children:(0,r.jsx)(a.ll,{className:"text-amber-950",children:"StoryForge"})}),(0,r.jsxs)(a.aY,{className:"text-sm",children:[(0,r.jsx)("div",{className:"text-amber-900/70 uppercase text-xs",children:"Title"}),(0,r.jsx)("div",{className:"font-serif text-lg",children:n})]})]})}},9346:function(e,t,n){"use strict";n.d(t,{Ol:function(){return a},Zb:function(){return i},aY:function(){return s},ll:function(){return l}});var r=n(5893);n(7294);let i=e=>{let{className:t="",...n}=e;return(0,r.jsx)("div",{className:"rounded-2xl border bg-white ".concat(t),...n})},a=e=>{let{className:t="",...n}=e;return(0,r.jsx)("div",{className:"px-4 py-3 border-b ".concat(t),...n})},l=e=>{let{className:t="",...n}=e;return(0,r.jsx)("div",{className:"text-lg font-semibold ".concat(t),...n})},s=e=>{let{className:t="",...n}=e;return(0,r.jsx)("div",{className:"px-4 py-3 ".concat(t),...n})}},8914:function(e,t,n){"use strict";function r(e){let t=[{label:"1-3",min:1,max:3},{label:"4-8",min:4,max:8},{label:"6-8",min:6,max:8},{label:"9-15",min:9,max:15},{label:"16-20",min:16,max:20},{label:"21-25",min:21,max:25},{label:"25+",min:25,max:Number.POSITIVE_INFINITY,isPlus:!0}];function n(e){if(isNaN(e)||e<=0)return"6-8";if(e>=25)return"25+";let n=null;for(let r of t){if(r.isPlus)continue;let t=Math.abs((r.min+r.max)/2-e);(!n||t<n.distance)&&(n={label:r.label,distance:t})}return n?n.label:"6-8"}if(!e||"string"!=typeof e)return"6-8";let r=e.toString().trim();if(!r)return"6-8";if(t.some(e=>e.label===r))return r;let i=r.toLowerCase();if(/(toddler|infant|baby)/.test(i))return"1-3";if(/(kid|child|children|elementary|grade school)/.test(i))return"6-8";if(/(teen|pre-?teen|middle school)/.test(i))return"16-20";if(/(adult|grown|mature)/.test(i))return"21-25";let a=i.match(/\b(\d{1,3})\s*\+\b/);if(a){let e=parseInt(a[1],10);if(!isNaN(e))return e>=25?"25+":n(e)}let l=i.match(/\b(\d{1,3})\s*(?:[-–—]|to|through|–)\s*(\d{1,3})\b/);if(l){let e=parseInt(l[1],10),t=parseInt(l[2],10);if(!isNaN(e)&&!isNaN(t))return function(e,t){let r=Math.min(e,t),i=Math.max(e,t);return isNaN(r)||isNaN(i)||r<=0?"6-8":i>=25?"25+":n((r+i)/2)}(e,t)}let s=i.match(/\b(\d{1,3})\b/);if(s){let e=parseInt(s[1],10);if(!isNaN(e))return n(e)}return"6-8"}function i(e){let t=r(e);if(/^\d{1,3}\+$/.test(t)){let e=parseInt(t.replace(/\D/g,""),10);return{ageMin:isNaN(e)?void 0:e,ageMax:void 0}}let n=t.match(/^(\d{1,3})-(\d{1,3})$/);if(n){let e=parseInt(n[1],10),t=parseInt(n[2],10);return{ageMin:isNaN(e)?void 0:e,ageMax:isNaN(t)?void 0:t}}return{}}function a(e){let{ageMin:t,ageMax:n}=i(e);return function(e,t){if(void 0!==e&&void 0!==t){if(t<=3)return{range:[50,150],label:"1–3"};if(e>=4&&t<=8)return{range:[500,1e3],label:"4–8"};if(e>=9&&t<=15)return{range:[1500,3e3],label:"9–15"};if(e>=16&&t<=20)return{range:[2500,4e3],label:"16–20"};if(e>=21&&t<=25)return{range:[3e3,5e3],label:"21–25"};if(e>=26||t>=26)return{range:[3e3,6e3],label:"25+"}}return{range:[3e3,5e3],label:"default-adult"}}(t,n)}function l(e){let{ageMin:t,ageMax:n}=i(e);return void 0!==n&&n<=3?"prose-xl md:prose-2xl":"prose-lg md:prose-xl"}function s(e){let{ageMin:t,ageMax:n}=i(e);return void 0!==n&&n<=3?"text-2xl md:text-3xl":"text-xl md:text-2xl"}n.d(t,{BU:function(){return a},FY:function(){return l},RH:function(){return r},VV:function(){return s}})},1207:function(e,t,n){"use strict";function r(e){let t=e.replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),n=[],r=1;function i(e,t){let i=e.replace(/^#{1,6}\s+/,"").trim(),a=(i=i.replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim())||"Chapter ".concat(r),l=(t||"").trim()||void 0;n.push({id:r++,heading:a,synopsis:l})}for(let e=0;e<t.length;e++){let n=t[e],r=n.match(/^\s*(?:\d+[\).]|[•\-*]|\d+\s+)\s*(.*)$/);if(r){let e=r[1].trim().split(/[—–\-:]\s+/);i((e[0]||"").replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim(),(e.slice(1).join(" - ")||"").trim());continue}let a=n.match(/^#{1,6}\s+(.*)$/);if(a){if(/table of contents/i.test(a[1]))continue;let n=t[e+1],r=n&&!/^#{1,6}\s+/.test(n)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(n);i(a[1],r?n:void 0),r&&e++;continue}let l=n.match(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*(.*)$/i);if(l){let n=t[e+1],r=n&&!/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i.test(n)&&!/^#{1,6}\s+/.test(n)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(n);i(l[1],r?n:void 0),r&&e++;continue}}if(0===n.length){let e=t.map(e=>e.replace(/\s{2,}$/,"").trim()).filter(Boolean).filter(e=>!/^table of contents$/i.test(e));if(e.length>=2)for(let t of e)i(t)}return n}function i(e,t){let n=t.split(/\r?\n/).filter(Boolean).slice(0,2).join(", ");return"".concat(e,": ").concat(n,". Cozy watercolor, soft light, storybook composition, ancient relic/tech motif.")}n.d(t,{B:function(){return r},Z:function(){return i}})},7563:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return f}});var r=n(5893),i=n(7294),a=n(1163),l=n(1891);let s=(0,n(1134).Z)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);var o=n(3432),c=n(7326),d=n(1207),u=n(2743),m=n(8914);function f(){let e=(0,a.useRouter)(),t="storyforge.session.v1",n="storyforge.seed.lock.v1",[f,p]=(0,i.useState)(""),[h,g]=(0,i.useState)(""),[x,b]=(0,i.useState)((0,m.RH)("6-8")),[y,N]=(0,i.useState)("fantasy"),[v,S]=(0,i.useState)(8),[w,j]=(0,i.useState)(""),[C,k]=(0,i.useState)("warm, whimsical, gentle-humor"),[I,O]=(0,i.useState)(null),[E,B]=(0,i.useState)(!0),[R,U]=(0,i.useState)(null),[M,T]=(0,i.useState)(null),[_,$]=(0,i.useState)([]),[J,D]=(0,i.useState)([]),[H,z]=(0,i.useState)(!1),[G,P]=(0,i.useState)(0),Z=(0,i.useRef)(!1);function F(e,t){let n=Math.max(1,Math.floor(t||0)),r=e.slice(0,n).map((e,t)=>({...e,id:t+1}));if(r.length===n)return r;let i=[];for(let e=r.length;e<n;e++)i.push({id:e+1,heading:"Chapter ".concat(e+1),synopsis:void 0});return[...r,...i]}return(0,i.useEffect)(()=>{try{let n=window.localStorage.getItem(t);if(n){var e;let r=JSON.parse(n),i=new URLSearchParams(window.location.search),a=(null==i?void 0:i.get("reseed"))==="1";if(a&&(0,u.$y)(),r.premise&&r.premise.includes("Cannot access uninitialized variable")){console.log("DEBUG: Sanitizing corrupted premise in localStorage"),r.premise="";try{window.localStorage.setItem(t,JSON.stringify(r))}catch(e){}}if(p(null!==(e=r.title)&&void 0!==e?e:""),g(r.premise||""),b((0,m.RH)(r.ageRange||"6-8")),N(r.genre||"fantasy"),S("number"==typeof r.chaptersTarget?r.chaptersTarget:8),j(r.keypoints||""),k(r.style||"warm, whimsical, gentle-humor"),O(r.coverUrl||null),a){T(null),$([]),j("");try{let e={...r,toc:null,chapters:[],seedSignature:void 0,keypoints:""};window.localStorage.setItem(t,JSON.stringify(e))}catch(e){}}else T(r.toc||null),$(Array.isArray(r.chapters)?r.chapters:[]);try{let e=(Array.isArray(r.scenes)?r.scenes:[]).map(e=>null==e?void 0:e.chapterId).filter(e=>"number"==typeof e);D(e)}catch(e){}}}catch(e){console.error("DEBUG Outline: localStorage error =",e)}finally{z(!0)}},[]),(0,i.useEffect)(()=>{(async()=>{try{if(console.log("DEBUG Outline useEffect: hydrated =",H,"toc =",M),!H)return;let e=JSON.stringify({title:f,premise:h,ageRange:(0,m.RH)(x),genre:y,chaptersTarget:v,keypoints:w,style:C});try{let n=window.localStorage.getItem(t),r=n?JSON.parse(n):{};if(r.seedSignature!==e){(0,u.$y)();let n={...r,seedSignature:e,toc:null,chapters:[]};try{window.localStorage.setItem(t,JSON.stringify(n))}catch(e){}T(null),$([])}}catch(e){}let r=new URLSearchParams(window.location.search),i=(null==r?void 0:r.get("reseed"))==="1";if(!i&&M&&0===G&&0===_.length){let e=(M||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,""),n=(0,d.B)(e),r=F(n,v);T(e),$(r);try{let n=window.localStorage.getItem(t),i={...n?JSON.parse(n):{},toc:e,chapters:r};window.localStorage.setItem(t,JSON.stringify(i))}catch(e){}return}if(!i&&M&&0===G||Z.current)return;try{let t=window.sessionStorage.getItem(n);if(!i&&0===G&&t===e){console.log("DEBUG Outline: Seeding locked for signature, skipping duplicate call");return}}catch(e){}let a="Cannot access uninitialized variable",l=f&&!f.includes(a)?f:"",s=h&&!h.includes(a)?h:"";console.log("DEBUG Outline: evaluating seed readiness. titleSafe =",l,"premiseSafe =",s),B(!0),U(null),Z.current=!0;try{window.sessionStorage.setItem(n,e)}catch(e){}if(!(l&&l.trim()||s&&s.trim())){console.log("DEBUG Outline: Missing title/premise after sanitize, setting error"),U("Missing seed info. Return and provide an idea or description."),B(!1);return}let o={title:l||"Untitled Codex",premise:s||l,prompt:s||l||"Untitled Codex",ageRange:(0,m.RH)(x),genre:y,chapters:v,keypoints:w||void 0,style:C,policyHint:"Fictionalize any sensitive or political content; avoid real names; keep it age-appropriate and non-political."};console.log("DEBUG Outline: Sending payload to seedStory @",(null===u.bV||void 0===u.bV?void 0:u.bV.seed)||"n/a","payload =",o);let{toc:c}=await (0,u.Mq)(o);console.log("DEBUG: Received TOC:",c);let p=(c||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,"");T(p);let g=(0,d.B)(p),b=F(g,v);$(b);try{let e=window.localStorage.getItem(t),n={...e?JSON.parse(e):{},toc:p,chapters:b};window.localStorage.setItem(t,JSON.stringify(n))}catch(e){}}catch(e){U((null==e?void 0:e.message)||"Seeding outline failed")}finally{B(!1),Z.current=!1;try{window.sessionStorage.removeItem(n)}catch(e){}G>0&&P(0)}})()},[H,G,f,h,x,y,v,w,C]),(0,r.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsxs)("div",{className:"mx-auto max-w-6xl px-4 py-8",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(l.E.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl bg-amber-200/70 p-2 shadow",children:(0,r.jsx)(s,{className:"h-6 w-6"})}),(0,r.jsx)(l.E.h1,{initial:{opacity:0,y:0},animate:{opacity:1,y:0},className:"text-2xl md:text-3xl font-serif tracking-wide",children:"Outline"}),(0,r.jsx)("button",{onClick:()=>e.push("/"),className:"ml-auto inline-flex items-center text-sm text-amber-900 underline hover:no-underline",children:"Forge New Story"})]}),(0,r.jsx)("p",{className:"mt-1 text-amber-900/80",children:f||"Untitled Codex"})]})}),(0,r.jsx)("main",{className:"relative mx-auto max-w-6xl px-4 pb-20",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,r.jsx)("div",{className:"lg:col-span-1",children:(0,r.jsx)(c.T,{coverUrl:I,title:f||"Untitled Codex"})}),(0,r.jsxs)("div",{className:"lg:col-span-2",children:[(0,r.jsxs)("div",{className:"relative rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px]",children:[E&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,r.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,r.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}),(0,r.jsx)("span",{children:"Engraving your table of contents…"})]})}),R&&(0,r.jsxs)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:[(0,r.jsx)("div",{children:R}),(0,r.jsx)("div",{className:"mt-2",children:(0,r.jsx)("button",{onClick:()=>P(e=>e+1),className:"rounded-lg bg-red-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]}),!E&&!R&&_.length>0&&(0,r.jsx)("ol",{className:"space-y-2",children:_.map(t=>{let n=J.includes(t.id);return(0,r.jsxs)("li",{className:"rounded-xl border p-3 cursor-pointer ".concat(n?"border-emerald-300 bg-emerald-50/60":"border-amber-200 bg-white/70"),onClick:()=>e.push({pathname:"/Read",query:{chapter:t.id,title:f||"Untitled Codex"}}),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"font-serif font-semibold",children:[t.id,". ",t.heading]}),(0,r.jsx)("div",{className:"text-xs text-amber-900/70",children:n?"engraved":"tap to generate"})]}),t.synopsis&&(0,r.jsx)("div",{className:"text-sm text-amber-900/80",children:t.synopsis})]},t.id)})}),!E&&!R&&0===_.length&&(0,r.jsxs)("div",{className:"text-amber-900/80",children:[(0,r.jsx)("div",{children:"No chapters detected. The model may have declined or produced non-TOC text."}),(0,r.jsx)("div",{className:"mt-2",children:(0,r.jsx)("button",{onClick:()=>P(e=>e+1),className:"rounded-lg bg-amber-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]})]}),(0,r.jsx)("div",{className:"mt-4 flex justify-end gap-2",children:_.length>0&&J.length>=_.length&&(0,r.jsx)("button",{onClick:()=>e.push("/Read?export=1"),className:"inline-flex items-center justify-center rounded-xl bg-amber-600 text-white px-5 py-3 shadow hover:bg-amber-700",disabled:E,children:"Export Full Book"})})]})]})})]})}}},function(e){e.O(0,[154,913,743,888,774,179],function(){return e(e.s=4349)}),_N_E=e.O()}]);