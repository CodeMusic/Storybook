(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(t,e,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(7154)}])},3432:function(t,e,r){"use strict";r.d(e,{Z:function(){return n}});let n=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7154:function(t,e,r){"use strict";r.r(e),r.d(e,{default:function(){return c}});var n=r(5893),a=r(7294),o=r(1163);let i=(0,r(1134).Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var l=r(3432),s=r(2743);function c(){var t,e,r,c;let u=(0,o.useRouter)(),d="storyforge.session.v1",p="string"==typeof(null===(t=u.query)||void 0===t?void 0:t.chapter)?parseInt(u.query.chapter,10):void 0,h=(null===(e=u.query)||void 0===e?void 0:e.export)==="1"||(null===(r=u.query)||void 0===r?void 0:r.export)==="true",[f,m]=(0,a.useState)(""),[y,g]=(0,a.useState)(null),[x,b]=(0,a.useState)([]),[w,v]=(0,a.useState)(null),[N,S]=(0,a.useState)([]),[j,E]=(0,a.useState)(!1),[k,O]=(0,a.useState)(null);(0,a.useEffect)(()=>{try{let e=window.localStorage.getItem(d);if(e){var t;let r=JSON.parse(e);m(null!==(t=r.title)&&void 0!==t?t:""),g(r.toc||null),b(Array.isArray(r.chapters)?r.chapters:[]),v(r.coverUrl||null);let n=(Array.isArray(r.scenes)?r.scenes:[]).map(t=>({...t,html:function t(e){let r=(e||"").toString().trim();if(!r)return"";try{let e=JSON.parse(r);if(Array.isArray(e)&&e.length>0){let r=e[0];if("string"==typeof(null==r?void 0:r.html))return r.html;if("string"==typeof(null==r?void 0:r.output))return t(r.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return t(e.output)}}catch(t){}if(/[<][a-zA-Z!/?]/.test(r))return r;let n=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");return r.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>"<p>".concat(n(t).replace(/\n/g,"<br/>"),"</p>")).join("\n")}((null==t?void 0:t.html)||"")}));S(n);try{let t={...r,scenes:n};window.localStorage.setItem(d,JSON.stringify(t))}catch(t){}}}catch(t){}},[]),(0,a.useEffect)(()=>{var t;let e="string"==typeof(null===(t=u.query)||void 0===t?void 0:t.title)?u.query.title:"";!f&&e&&e.trim()&&m(e)},[null===(c=u.query)||void 0===c?void 0:c.title,f]),(0,a.useEffect)(()=>{(async()=>{if(h)try{E(!0);let{downloadUrl:t}=await (0,s.WF)({htmlPages:N.map(t=>t.html),coverUrl:w,meta:{title:f,toc:y,chapters:x}});t&&window.open(t,"_blank")}catch(t){O(t.message||"Export failed")}finally{E(!1)}})()},[h]);let C=(0,a.useMemo)(()=>{if("number"==typeof p&&!isNaN(p)){let t=x.findIndex(t=>t.id===p);return t>=0?t:0}return Math.min(N.length,Math.max(0,(x.length,0)))},[p,x,N.length]);async function _(){if(!x.length)return;let t=x[C];if(t&&!N.some(e=>e.chapterId===t.id))try{E(!0),O(null);let e={title:f,toc:y,priorHtml:N.map(t=>t.html)},{html:r}=await (0,s.Yl)({context:e,chapterIndex:C}),n=null;try{n=(await (0,s.km)("".concat(f,": ").concat(t.heading,". ").concat(r.slice(0,180),"..."))).url}catch(t){}let a=[...N,{chapterId:t.id,chapterHeading:t.heading,html:r,imageUrl:n}];S(a);try{let t=window.localStorage.getItem(d),e={...t?JSON.parse(t):{},scenes:a};window.localStorage.setItem(d,JSON.stringify(e))}catch(t){}}catch(t){O(t.message||"Chapter failed")}finally{E(!1)}}(0,a.useEffect)(()=>{_()},[C,x.length]);let A=(0,a.useMemo)(()=>{if("number"==typeof p&&!isNaN(p)){let t=N.find(t=>t.chapterId===p);if(t)return t}return N[C]},[N,C,p]),U=(0,a.useMemo)(()=>{if(!x.length)return;let t=Math.max(0,C-1);if(t!==C)return x[t]},[x,C]),I=(0,a.useMemo)(()=>{if(!x.length)return;let t=Math.min(x.length-1,C+1);if(t!==C)return x[t]},[x,C]);return(0,n.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,n.jsx)("header",{className:"relative",children:(0,n.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,n.jsxs)("button",{onClick:()=>u.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,n.jsx)(i,{className:"h-4 w-4"})," Back to outline"]}),(0,n.jsx)("h1",{className:"mt-2 text-2xl font-serif",children:f||"Untitled Codex"})]})}),(0,n.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative",children:[j&&(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,n.jsx)(l.Z,{className:"h-5 w-5 animate-spin"}),(0,n.jsx)("span",{children:"Engraving chapterâ€¦"})]})}),k&&(0,n.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:k}),A&&(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"font-serif text-xl mb-2",children:["Chapter ",A.chapterId,": ",A.chapterHeading]}),A.imageUrl&&(0,n.jsx)("img",{src:A.imageUrl,alt:"Scene",className:"w-full h-auto rounded-lg border border-amber-200 mb-3"}),(0,n.jsx)("div",{className:"prose prose-amber max-w-none",dangerouslySetInnerHTML:{__html:A.html}})]})]})}),!j&&(0,n.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,n.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,n.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,n.jsx)("button",{onClick:()=>u.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>{U&&u.push({pathname:"/Read",query:{chapter:U.id,title:f||"Untitled Codex"}})},disabled:!U,className:"rounded-xl border px-4 py-2 text-sm ".concat(U?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:U?"Previous: Chapter ".concat(U.id):"Previous"}),x.length>0&&N.length>=x.length?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:()=>u.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,n.jsx)("button",{onClick:()=>u.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,n.jsx)("button",{onClick:()=>{I&&u.push({pathname:"/Read",query:{chapter:I.id,title:f||"Untitled Codex"}})},disabled:!I,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(I?"":"opacity-50 cursor-not-allowed"),children:I?"Next: Chapter ".concat(I.id):"Next"})]})]})})})]})}},2743:function(t,e,r){"use strict";r.d(e,{Mq:function(){return f},WF:function(){return x},Yl:function(){return m},bV:function(){return s},km:function(){return g},o9:function(){return b},tH:function(){return o}});var n=r(4406),a=r(8834).lW;let o="https://n8n.codemusic.ca/webhook",i=n.env.NEXT_PUBLIC_N8N_USER||"siteuser",l=n.env.NEXT_PUBLIC_N8N_PASS||"codemusai",s={prime:"".concat(o,"/seedInfo"),seed:"".concat(o,"/seedStory"),chapter:"".concat(o,"/expandChapter"),image:"".concat(o,"/genImage"),export:"".concat(o,"/exportBook")};function c(){let t="".concat(i,":").concat(l);try{let e="function"==typeof btoa?btoa(t):a.from(t).toString("base64");return"Basic ".concat(e)}catch(t){return""}}function u(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e5,n=new AbortController,a=setTimeout(()=>n.abort(),r);return fetch(t,{...e,signal:n.signal}).finally(()=>clearTimeout(a))}async function d(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(e)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));if(!n)throw Error("Empty response");return n}async function p(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(e)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));try{return JSON.parse(n)}catch(t){throw Error("Invalid JSON response")}}async function h(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(e)}),n=await r.text();if(!r.ok)throw Error(n||"Endpoint error ".concat(r.status));return n}async function f(t){console.log("DEBUG seedStory: endpoint =",s.seed),console.log("DEBUG seedStory: payload =",t);try{let e=await d(s.seed,t);console.log("DEBUG seedStory: raw response =",e);let r=function(t){let e=(t||"").toString().trim();if(!e)return e;try{let t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){let e=t[0];if("string"==typeof(null==e?void 0:e.toc))return e.toc;if("string"==typeof(null==e?void 0:e.output))return e.output}if("object"==typeof t&&t){if("string"==typeof t.toc)return t.toc;if("string"==typeof t.output)return t.output}}catch(t){}return e}(e);return console.log("DEBUG seedStory: parsed toc =",r),{toc:r}}catch(t){throw console.error("DEBUG seedStory: error =",t),t}}async function m(t){return{html:function t(e){let r=(e||"").toString().trim();if(!r)return"";try{let e=JSON.parse(r);if(Array.isArray(e)&&e.length>0){let r=e[0];if("string"==typeof(null==r?void 0:r.html))return r.html;if("string"==typeof(null==r?void 0:r.output))return t(r.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return t(e.output)}}catch(t){}return/[<][a-zA-Z!/?]/.test(r)?r:r.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>{let e=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br/>");return"<p>".concat(e,"</p>")}).join("\n")}(await d(s.chapter,t))}}async function y(t,e){let r=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:c()},body:JSON.stringify(e)}),n=r.headers.get("content-type")||"";if(!r.ok)throw Error(await r.text().catch(()=>"")||"Endpoint error ".concat(r.status));if(n.startsWith("image/")){let t=await r.blob();return URL.createObjectURL(t)}let a=await r.text();try{let t=JSON.parse(a);if("string"==typeof(null==t?void 0:t.url))return t.url;if("string"==typeof(null==t?void 0:t.data)){let e=(null==t?void 0:t.mime)||(null==t?void 0:t.type)||"image/png";if(t.data.startsWith("data:"))return t.data;return"data:".concat(e,";base64,").concat(t.data)}}catch(t){}let o=a.trim();if(!o)throw Error("Empty response");return o}async function g(t){return{url:await y(s.image,{prompt:t})}}async function x(t){try{return{downloadUrl:await d(s.export,t)}}catch(t){return{downloadUrl:null}}}async function b(t){try{let e=await p(s.prime,t),r=t=>{let e=(t||"").trim(),r=e.match(/```\s*json\s*([\s\S]*?)```/i)||e.match(/```\s*([\s\S]*?)```/i),n=(r?r[1]:e).trim();n=n.replace(/^\s*\(\s*/,"").replace(/\s*\)\s*$/,"");try{let t=JSON.parse(n);if(t&&"object"==typeof t){let e={title:t.title,description:t.description,ageRange:t.ageRange,genre:t.genre,chapters:t.chapters,keypoints:t.keypoints,style:t.style};if(Object.values(e).some(t=>null!=t&&""!==t))return e}}catch(t){}let a=e.split(/\r?\n/).filter(Boolean);return a.length>=3&&a.slice(0,3).every(t=>/^(\s*(\d+[\).]|[â€¢\-*])\s*)?/.test(t))?{toc:e}:{description:e}};if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.output))return{info:r(t.output)};if(t&&"object"==typeof t)return{info:t}}if("string"==typeof(null==e?void 0:e.output))return{info:r(e.output)};return{info:e}}catch(e){try{let e=(await h(s.prime,t)||"").toString().trim();return{info:e?{description:e}:{}}}catch(t){throw t}}}}},function(t){t.O(0,[295,888,774,179],function(){return t(t.s=9749)}),_N_E=t.O()}]);