(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[673],{9749:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Read",function(){return r(8254)}])},1134:function(e,t,r){"use strict";r.d(t,{Z:function(){return o}});var a=r(7294);let n=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),l=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&""!==e.trim()&&r.indexOf(e)===t).join(" ").trim()};var i={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let s=(0,a.forwardRef)((e,t)=>{let{color:r="currentColor",size:n=24,strokeWidth:s=2,absoluteStrokeWidth:o,className:c="",children:u,iconNode:d,...m}=e;return(0,a.createElement)("svg",{ref:t,...i,width:n,height:n,stroke:r,strokeWidth:o?24*Number(s)/Number(n):s,className:l("lucide",c),...m},[...d.map(e=>{let[t,r]=e;return(0,a.createElement)(t,r)}),...Array.isArray(u)?u:[u]])}),o=(e,t)=>{let r=(0,a.forwardRef)((r,i)=>{let{className:o,...c}=r;return(0,a.createElement)(s,{ref:i,iconNode:t,className:l("lucide-".concat(n(e)),o),...c})});return r.displayName="".concat(e),r}},3432:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},5062:function(e,t,r){"use strict";r.d(t,{Z:function(){return a}});let a=(0,r(1134).Z)("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]])},8914:function(e,t,r){"use strict";function a(e){let t=[{label:"1-3",min:1,max:3},{label:"4-8",min:4,max:8},{label:"6-8",min:6,max:8},{label:"9-15",min:9,max:15},{label:"16-20",min:16,max:20},{label:"21-25",min:21,max:25},{label:"25+",min:25,max:Number.POSITIVE_INFINITY,isPlus:!0}];function r(e){if(isNaN(e)||e<=0)return"6-8";if(e>=25)return"25+";let r=null;for(let a of t){if(a.isPlus)continue;let t=Math.abs((a.min+a.max)/2-e);(!r||t<r.distance)&&(r={label:a.label,distance:t})}return r?r.label:"6-8"}if(!e||"string"!=typeof e)return"6-8";let a=e.toString().trim();if(!a)return"6-8";if(t.some(e=>e.label===a))return a;let n=a.toLowerCase();if(/(toddler|infant|baby)/.test(n))return"1-3";if(/(kid|child|children|elementary|grade school)/.test(n))return"6-8";if(/(teen|pre-?teen|middle school)/.test(n))return"16-20";if(/(adult|grown|mature)/.test(n))return"21-25";let l=n.match(/\b(\d{1,3})\s*\+\b/);if(l){let e=parseInt(l[1],10);if(!isNaN(e))return e>=25?"25+":r(e)}let i=n.match(/\b(\d{1,3})\s*(?:[-–—]|to|through|–)\s*(\d{1,3})\b/);if(i){let e=parseInt(i[1],10),t=parseInt(i[2],10);if(!isNaN(e)&&!isNaN(t))return function(e,t){let a=Math.min(e,t),n=Math.max(e,t);return isNaN(a)||isNaN(n)||a<=0?"6-8":n>=25?"25+":r((a+n)/2)}(e,t)}let s=n.match(/\b(\d{1,3})\b/);if(s){let e=parseInt(s[1],10);if(!isNaN(e))return r(e)}return"6-8"}function n(e){let t=a(e);if(/^\d{1,3}\+$/.test(t)){let e=parseInt(t.replace(/\D/g,""),10);return{ageMin:isNaN(e)?void 0:e,ageMax:void 0}}let r=t.match(/^(\d{1,3})-(\d{1,3})$/);if(r){let e=parseInt(r[1],10),t=parseInt(r[2],10);return{ageMin:isNaN(e)?void 0:e,ageMax:isNaN(t)?void 0:t}}return{}}function l(e){let{ageMin:t,ageMax:r}=n(e);return function(e,t){if(void 0!==e&&void 0!==t){if(t<=3)return{range:[50,150],label:"1–3"};if(e>=4&&t<=8)return{range:[500,1e3],label:"4–8"};if(e>=9&&t<=15)return{range:[1500,3e3],label:"9–15"};if(e>=16&&t<=20)return{range:[2500,4e3],label:"16–20"};if(e>=21&&t<=25)return{range:[3e3,5e3],label:"21–25"};if(e>=26||t>=26)return{range:[3e3,6e3],label:"25+"}}return{range:[3e3,5e3],label:"default-adult"}}(t,r)}function i(e){let{ageMin:t,ageMax:r}=n(e);return void 0!==r&&r<=3?"prose-xl md:prose-2xl":"prose-lg md:prose-xl"}function s(e){let{ageMin:t,ageMax:r}=n(e);return void 0!==r&&r<=3?"text-2xl md:text-3xl":"text-xl md:text-2xl"}r.d(t,{BU:function(){return l},FY:function(){return i},RH:function(){return a},VV:function(){return s}})},8254:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return h}});var a=r(5893),n=r(7294),l=r(1163),i=r(1134);let s=(0,i.Z)("CornerUpLeft",[["polyline",{points:"9 14 4 9 9 4",key:"881910"}],["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}]]);var o=r(3432);let c=(0,i.Z)("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]);var u=r(5062),d=r(2743),m=r(8914);function h(){var e,t,r,i;let h=(0,l.useRouter)(),p="storyforge.session.v1",f="string"==typeof(null===(e=h.query)||void 0===e?void 0:e.chapter)?parseInt(h.query.chapter,10):void 0,g=(null===(t=h.query)||void 0===t?void 0:t.export)==="1"||(null===(r=h.query)||void 0===r?void 0:r.export)==="true",[x,b]=(0,n.useState)(""),[y,w]=(0,n.useState)(null),[v,N]=(0,n.useState)([]),[j,S]=(0,n.useState)(null),[k,C]=(0,n.useState)([]),[I,E]=(0,n.useState)(!1),[P,_]=(0,n.useState)(null),[M,O]=(0,n.useState)((0,m.RH)("6-8")),[R,$]=(0,n.useState)("fantasy"),[A,U]=(0,n.useState)(""),[L,Z]=(0,n.useState)("warm, whimsical, gentle-humor"),F=(0,m.FY)(M),H=(0,m.VV)(M),[q,T]=(0,n.useState)(""),[W,z]=(0,n.useState)(null),[B,J]=(0,n.useState)(null),[V,Y]=(0,n.useState)(""),[D,X]=(0,n.useState)(!1),G="storyforge.streaming.v1",[K,Q]=(0,n.useState)(null),[ee,et]=(0,n.useState)(null),[er,ea]=(0,n.useState)(!1),[en,el]=(0,n.useState)(!1),[ei,es]=(0,n.useState)(!1),[eo,ec]=(0,n.useState)(null);function eu(e){let t=ed((e||"").toString());return t.trim()?/[<][a-zA-Z!\/?]/.test(t)?eh(t):function(e){let t=ed(e||"");if(!t.trim())return"";let r=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/^######\s+(.*)$/gm,"<h6>$1</h6>")).replace(/^#####\s+(.*)$/gm,"<h5>$1</h5>")).replace(/^####\s+(.*)$/gm,"<h4>$1</h4>")).replace(/^###\s+(.*)$/gm,"<h3>$1</h3>")).replace(/^##\s+(.*)$/gm,"<h2>$1</h2>")).replace(/^#\s+(.*)$/gm,"<h1>$1</h1>")).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/(^|[^_])_([^_\n][^_]*)_/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).replace(/(^|[^*])\*([^*\n][^*]*)\*/g,(e,t,r)=>"".concat(t,"<em>").concat(r,"</em>"))).split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>/^<h[1-6]>/.test(e)?e:"<p>".concat(e.replace(/\n/g,"<br/>"),"</p>")).join("\n")}(t):""}function ed(e){if(!e)return e;let t=e.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");return(t=t.replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(parseInt(t,10)))).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}function em(e,t,r){if(!e||!e.trim())return e;let a=e.split(/(<[^>]+>)/g),n=0,l=!1;return a.map(e=>e.startsWith("<")?e:e.replace(/([\w'’]+)(\s*)/g,(e,a,i)=>{if(n++,!l&&(null==r?void 0:r.skipFirstWord))return l=!0,"".concat(a).concat(i);let s=n>Math.max(0,n-t);return'<span class="'.concat(s?"word word-new":"word",'">').concat(a,"</span>").concat(i)})).join("")}function eh(e){let t=(e||"").toString().trim();if(!t)return"";try{let e=JSON.parse(t);if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.html))return t.html;if("string"==typeof(null==t?void 0:t.output))return eh(t.output)}if("object"==typeof e&&e){if("string"==typeof e.html)return e.html;if("string"==typeof e.output)return eh(e.output)}}catch(e){}if(/[<][a-zA-Z!\/?]/.test(t))return ed(t);let r=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return ed(t).split(/\n{2,}/).map(e=>e.trim()).filter(Boolean).map(e=>"<p>".concat(r(e).replace(/\n/g,"<br/>"),"</p>")).join("\n")}(0,n.useEffect)(()=>{let e=()=>{if(D){try{h.events.emit("routeChangeError")}catch(e){}throw"Route change aborted: streaming in progress"}},t=e=>{D&&(e.preventDefault(),e.returnValue="")};return h.events.on("routeChangeStart",e),window.addEventListener("beforeunload",t),()=>{h.events.off("routeChangeStart",e),window.removeEventListener("beforeunload",t)}},[D,h.events]),(0,n.useEffect)(()=>{try{let e=window.localStorage.getItem(G);if(!e)return;let t=JSON.parse(e);t&&"number"==typeof t.chapterId&&!k.some(e=>e.chapterId===t.chapterId)&&(X(!0),J(t.chapterId),Y(t.chapterHeading||""),z(t.imageUrl||null),T(eu(t.rawText||"")),E(!1))}catch(e){}},[]),(0,n.useEffect)(()=>{try{let t=window.localStorage.getItem(p);if(t){var e;let r=JSON.parse(t);b(null!==(e=r.title)&&void 0!==e?e:""),w(r.toc||null),N(Array.isArray(r.chapters)?r.chapters:[]),S(r.coverUrl||null),O((0,m.RH)(r.ageRange||"6-8")),$(r.genre||"fantasy"),U(r.keypoints||""),Z(r.style||"warm, whimsical, gentle-humor");let a=(Array.isArray(r.scenes)?r.scenes:[]).map(e=>({...e,html:eh((null==e?void 0:e.html)||"")}));C(a);try{let e={...r,scenes:a};window.localStorage.setItem(p,JSON.stringify(e))}catch(e){}}}catch(e){}},[]),(0,n.useEffect)(()=>{var e;let t="string"==typeof(null===(e=h.query)||void 0===e?void 0:e.title)?h.query.title:"";!x&&t&&t.trim()&&b(t)},[null===(i=h.query)||void 0===i?void 0:i.title,x]),(0,n.useEffect)(()=>{(async()=>{if(g)try{E(!0);let{downloadUrl:e,filename:t}=await (0,d.WF)({scenes:k,coverUrl:j,meta:{title:x,toc:y,chapters:v}});if(e){let r=document.createElement("a");r.href=e,r.download=t||"".concat(x||"storybook",".html"),document.body.appendChild(r),r.click(),r.remove(),e.startsWith("blob:")&&URL.revokeObjectURL(e)}}catch(e){_(e.message||"Export failed")}finally{E(!1)}})()},[g]);let ep=(0,n.useMemo)(()=>{if("number"==typeof f&&!isNaN(f)){let e=v.findIndex(e=>e.id===f);return e>=0?e:0}return Math.min(k.length,Math.max(0,(v.length,0)))},[f,v,k.length]);async function ef(){if(!v.length)return;let e=v[ep];if(e&&!k.some(t=>t.chapterId===e.id))try{E(!0),_(null);let t=(0,m.RH)(M),r=(0,m.BU)(t),a={title:x,toc:y,priorHtml:k.map(e=>e.html),ageRange:t,lengthHint:r,genre:R,keypoints:A,style:L},n="[context: genre=".concat(R,"; age=").concat(t,"; style=").concat(L,"; notes=").concat((A||"").slice(0,120),"]");X(!0),J(e.id),Y(e.heading),T(""),z(null);let l=null;try{let r="".concat(x||"Untitled Codex"," (ages ").concat(t,"): Chapter ").concat(e.id," - ").concat(e.heading,". Genre ").concat(R,". Style ").concat(L,"."),a=await (0,d.km)(r),n=(null==a?void 0:a.url)||null;if(n){l=n;let e=new Promise(e=>{try{let t=new Image;try{t.decoding="async"}catch(e){}try{t.loading="eager"}catch(e){}t.onload=()=>e(),t.onerror=()=>e(),t.src=n}catch(t){e()}});try{if("undefined"!=typeof document){let e=document.createElement("link");e.rel="preload",e.as="image",e.href=n,document.head.appendChild(e),setTimeout(()=>{try{document.head.removeChild(e)}catch(e){}},15e3)}}catch(e){}await Promise.race([e,new Promise(e=>setTimeout(e,4e3))]),z(n)}}catch(e){l=null}let i="",s=!1,o=0;for await(let t of(0,d.nq)({context:a,chapterIndex:ep,influence:n,lengthHint:r})){i+=function(e){if(!e)return e;let t=ed(e);t=t.replace(/^\s*Scene\b[\s:]*/i,"");for(let e=0;e<3;e++){let e=t.match(/\{[\s\S]*?\}/);if(!e)break;try{let r=JSON.parse(e[0]);if(r&&"object"==typeof r&&"name"in r&&"parameters"in r){t=t.slice(0,e.index||0)+t.slice((e.index||0)+e[0].length);continue}}catch(e){}break}return t}(t),!s&&t&&t.trim()&&(E(!1),s=!0);let r=eu(i),a=r.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),n=a?a.split(" ").length:0,l=Math.max(0,n-o),c=em(r,l,{skipFirstWord:!0});o=n,T(c);try{{let t={chapterId:e.id,chapterHeading:e.heading,rawText:i,imageUrl:W};window.localStorage.setItem(G,JSON.stringify(t))}}catch(e){}}let c=(()=>{let e=eu(i);return'<div class="words-flash">'.concat(em(e,0,{skipFirstWord:!0}),"</div>")})(),u=l||W,h=[...k,{chapterId:e.id,chapterHeading:e.heading,html:c,imageUrl:u}];C(h);try{let e=window.localStorage.getItem(p),t={...e?JSON.parse(e):{},scenes:h};window.localStorage.setItem(p,JSON.stringify(t))}catch(e){}try{window.localStorage.removeItem(G)}catch(e){}}catch(e){_(e.message||"Chapter failed")}finally{X(!1),J(null),Y(""),T(""),I&&E(!1)}}(0,n.useEffect)(()=>{ef()},[ep,v.length]);let eg=(0,n.useMemo)(()=>{if("number"==typeof f&&!isNaN(f)){let e=k.find(e=>e.chapterId===f);if(e)return e}return k[ep]},[k,ep,f]),ex=(0,n.useMemo)(()=>{if(!v.length)return;let e=Math.max(0,ep-1);if(e!==ep)return v[e]},[v,ep]),eb=(0,n.useMemo)(()=>{if(!v.length)return;let e=Math.min(v.length-1,ep+1);if(e!==ep)return v[e]},[v,ep]),ey=(0,n.useMemo)(()=>D?q:(null==eg?void 0:eg.html)?eg.html:"",[null==eg?void 0:eg.html,D,q]),[ew,ev]=(0,n.useState)(!1);async function eN(){try{if(!eg||!eg.html||en)return;try{let e=window.AudioContext||window.webkitAudioContext;if(e){let t=eo||new e;ec(t),"running"!==t.state&&await t.resume().catch(()=>{})}}catch(e){}if(ee&&K){if(er)ee.pause(),ea(!1);else try{await ee.play(),ea(!0),es(!1)}catch(e){es(!0)}return}el(!0);let e=(eg.html||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),{url:t}=await (0,d.vz)(e);Q(t);let r=new Audio;r.preload="auto";try{r.crossOrigin="anonymous"}catch(e){}r.src=t,r.onended=()=>ea(!1),et(r);try{await r.play(),ea(!0),es(!1)}catch(e){es(!0),ea(!1)}}catch(e){_((null==e?void 0:e.message)||"Audio failed")}finally{el(!1)}}async function ej(e){try{ev(!0),await new Promise(e=>setTimeout(e,460))}finally{ev(!1),h.push({pathname:"/Read",query:e})}}return(0,n.useEffect)(()=>()=>{try{ee&&ee.pause()}catch(e){}try{K&&K.startsWith("blob:")&&URL.revokeObjectURL(K)}catch(e){}et(null),Q(null),ea(!1)},[ep]),(0,a.jsxs)("div",{className:"min-h-screen text-amber-950 font-story-body ".concat(ew?"is-turning":""," page-turning"),children:[(0,a.jsx)("header",{className:"relative",children:(0,a.jsxs)("div",{className:"mx-auto max-w-3xl px-4 py-6",children:[(0,a.jsxs)("button",{onClick:()=>h.push("/Outline"),className:"inline-flex items-center gap-2 text-amber-900 hover:underline",children:[(0,a.jsx)(s,{className:"h-4 w-4"})," Back to outline"]}),(0,a.jsx)("h1",{className:"mt-2 text-2xl font-story-title",children:x||"StoryForge"})]})}),(0,a.jsx)("main",{className:"mx-auto max-w-3xl px-4 pb-32",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px] relative page",children:[I&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,a.jsx)(o.Z,{className:"h-5 w-5 animate-spin"}),(0,a.jsx)("span",{children:"Engraving chapter…"})]})}),P&&(0,a.jsx)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:P}),(eg||D)&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-story-title ".concat(H," mb-2 text-amber-900"),children:["Chapter ",eg?eg.chapterId:B,": ",eg?eg.chapterHeading:V]}),((null==eg?void 0:eg.imageUrl)||W)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("img",{src:(null==eg?void 0:eg.imageUrl)||W,alt:"Scene",loading:"eager",decoding:"async",fetchPriority:"high",className:"w-full h-auto rounded-lg border border-amber-200 mb-2"}),!!eg&&!D&&(0,a.jsx)("div",{className:"flex justify-end mb-3",children:(0,a.jsxs)("button",{onClick:eN,disabled:en,className:"inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 hover:bg-amber-100 shadow-sm","aria-label":er?"Pause narration":"Play narration",children:[er?(0,a.jsx)(c,{className:"h-4 w-4"}):(0,a.jsx)(u.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"text-xs",children:er?"Pause":en?"Preparing…":"Play"})]})})]}),!(null==eg?void 0:eg.imageUrl)&&!!eg&&!D&&(0,a.jsx)("div",{className:"flex justify-end mb-3",children:(0,a.jsxs)("button",{onClick:eN,disabled:en,className:"inline-flex items-center gap-1 rounded-full border border-amber-300 bg-white/70 backdrop-blur px-3 py-1 text-amber-900 hover:bg-amber-100 shadow-sm","aria-label":er?"Pause narration":"Play narration",children:[er?(0,a.jsx)(c,{className:"h-4 w-4"}):(0,a.jsx)(u.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"text-xs",children:er?"Pause":en?"Preparing…":"Play"})]})}),(0,a.jsx)("div",{className:"".concat(F," prose-amber prose-story dropcap font-story-body max-w-none ").concat(D?"story-hit":""),dangerouslySetInnerHTML:{__html:ey}})]})]})}),!I&&(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-20",children:(0,a.jsx)("div",{className:"mx-auto max-w-3xl px-4 pb-4",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-amber-300 bg-amber-50/90 backdrop-blur px-3 py-3 shadow-lg flex items-center justify-between gap-3",children:[(0,a.jsx)("button",{onClick:()=>h.push("/Outline"),className:"text-sm underline text-amber-900",children:"Back to outline"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>{ex&&ej({chapter:ex.id,title:x||"Untitled Codex"})},disabled:!ex,className:"rounded-xl border px-4 py-2 text-sm ".concat(ex?"bg-white hover:bg-amber-100":"opacity-50 cursor-not-allowed"),children:ex?"Previous: Chapter ".concat(ex.id):"Previous"}),v.length>0&&k.length>=v.length?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>h.push("/Outline"),className:"rounded-xl border px-4 py-2 text-sm bg-white hover:bg-amber-100",children:"Return to table of contents"}),(0,a.jsx)("button",{onClick:()=>h.push("/Read?export=1"),className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700",children:"Export Book"})]}):(0,a.jsx)("button",{onClick:()=>{eb&&ej({chapter:eb.id,title:x||"Untitled Codex"})},disabled:!eb,className:"rounded-xl bg-amber-600 text-white px-4 py-2 text-sm hover:bg-amber-700 ".concat(eb?"":"opacity-50 cursor-not-allowed"),children:eb?"Next: Chapter ".concat(eb.id):"Next"})]})]})})})]})}}},function(e){e.O(0,[154,743,888,774,179],function(){return e(e.s=9749)}),_N_E=e.O()}]);