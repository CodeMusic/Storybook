(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{4349:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Outline",function(){return s(7563)}])},3432:function(e,t,s){"use strict";s.d(t,{Z:function(){return i}});let i=(0,s(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7326:function(e,t,s){"use strict";s.d(t,{T:function(){return a}});var i=s(5893),n=s(7294),r=s(9346);function a(e){let{coverUrl:t,title:s,onBroken:a}=e,[l,c]=(0,n.useState)(!1);return(0,i.jsxs)(r.Zb,{className:"bg-amber-50/80 border-amber-300 overflow-hidden",children:[t&&(0,i.jsx)("img",{src:t,alt:"Cover",className:"w-full aspect-[4/3] object-cover",onError:function(){if(!l){c(!0);try{a&&a()}catch(e){}}}}),(0,i.jsx)(r.Ol,{children:(0,i.jsx)(r.ll,{className:"text-amber-950",children:"Codex Core"})}),(0,i.jsxs)(r.aY,{className:"text-sm",children:[(0,i.jsx)("div",{className:"text-amber-900/70 uppercase text-xs",children:"Title"}),(0,i.jsx)("div",{className:"font-serif text-lg",children:s})]})]})}},9346:function(e,t,s){"use strict";s.d(t,{Ol:function(){return r},Zb:function(){return n},aY:function(){return l},ll:function(){return a}});var i=s(5893);s(7294);let n=e=>{let{className:t="",...s}=e;return(0,i.jsx)("div",{className:"rounded-2xl border bg-white ".concat(t),...s})},r=e=>{let{className:t="",...s}=e;return(0,i.jsx)("div",{className:"px-4 py-3 border-b ".concat(t),...s})},a=e=>{let{className:t="",...s}=e;return(0,i.jsx)("div",{className:"text-lg font-semibold ".concat(t),...s})},l=e=>{let{className:t="",...s}=e;return(0,i.jsx)("div",{className:"px-4 py-3 ".concat(t),...s})}},1207:function(e,t,s){"use strict";function i(e){let t=e.replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),s=[],i=1;function n(e,t){let n=e.replace(/^#{1,6}\s+/,"").trim(),r=(n=n.replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim())||"Chapter ".concat(i),a=(t||"").trim()||void 0;s.push({id:i++,heading:r,synopsis:a})}for(let e=0;e<t.length;e++){let s=t[e],i=s.match(/^\s*(?:\d+[\).]|[•\-*]|\d+\s+)\s*(.*)$/);if(i){let e=i[1].trim().split(/[—–\-:]\s+/);n((e[0]||"").replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim(),(e.slice(1).join(" - ")||"").trim());continue}let r=s.match(/^#{1,6}\s+(.*)$/);if(r){if(/table of contents/i.test(r[1]))continue;let s=t[e+1],i=s&&!/^#{1,6}\s+/.test(s)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(s);n(r[1],i?s:void 0),i&&e++;continue}let a=s.match(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*(.*)$/i);if(a){let s=t[e+1],i=s&&!/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i.test(s)&&!/^#{1,6}\s+/.test(s)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(s);n(a[1],i?s:void 0),i&&e++;continue}}if(0===s.length){let e=t.map(e=>e.replace(/\s{2,}$/,"").trim()).filter(Boolean).filter(e=>!/^table of contents$/i.test(e));if(e.length>=2)for(let t of e)n(t)}return s}function n(e,t){let s=t.split(/\r?\n/).filter(Boolean).slice(0,2).join(", ");return"".concat(e,": ").concat(s,". Cozy watercolor, soft light, storybook composition, ancient relic/tech motif.")}s.d(t,{B:function(){return i},Z:function(){return n}})},7563:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return p}});var i=s(5893),n=s(7294),r=s(1163),a=s(1891);let l=(0,s(1134).Z)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);var c=s(3432),o=s(7326),d=s(1207),u=s(2743),m=s(8914);function p(){let e=(0,r.useRouter)(),t="storyforge.session.v1",s="storyforge.seed.lock.v1",[p,h]=(0,n.useState)(""),[g,x]=(0,n.useState)(""),[f,y]=(0,n.useState)((0,m.RH)("6-8")),[b,v]=(0,n.useState)("fantasy"),[w,S]=(0,n.useState)(8),[N,j]=(0,n.useState)(""),[C,O]=(0,n.useState)("warm, whimsical, gentle-humor"),[k,E]=(0,n.useState)(null),[B,R]=(0,n.useState)(!0),[U,I]=(0,n.useState)(null),[T,_]=(0,n.useState)(null),[J,z]=(0,n.useState)([]),[D,G]=(0,n.useState)([]),[H,$]=(0,n.useState)(!1),[M,Z]=(0,n.useState)(0),A=(0,n.useRef)(!1);function P(e,t){let s=Math.max(1,Math.floor(t||0)),i=e.slice(0,s).map((e,t)=>({...e,id:t+1}));if(i.length===s)return i;let n=[];for(let e=i.length;e<s;e++)n.push({id:e+1,heading:"Chapter ".concat(e+1),synopsis:void 0});return[...i,...n]}return(0,n.useEffect)(()=>{try{let s=window.localStorage.getItem(t);if(s){var e;let i=JSON.parse(s),n=new URLSearchParams(window.location.search),r=(null==n?void 0:n.get("reseed"))==="1";if(i.premise&&i.premise.includes("Cannot access uninitialized variable")){console.log("DEBUG: Sanitizing corrupted premise in localStorage"),i.premise="";try{window.localStorage.setItem(t,JSON.stringify(i))}catch(e){}}if(h(null!==(e=i.title)&&void 0!==e?e:""),x(i.premise||""),y((0,m.RH)(i.ageRange||"6-8")),v(i.genre||"fantasy"),S("number"==typeof i.chaptersTarget?i.chaptersTarget:8),j(i.keypoints||""),O(i.style||"warm, whimsical, gentle-humor"),E(i.coverUrl||null),r){_(null),z([]),j("");try{let e={...i,toc:null,chapters:[],seedSignature:void 0,keypoints:""};window.localStorage.setItem(t,JSON.stringify(e))}catch(e){}}else _(i.toc||null),z(Array.isArray(i.chapters)?i.chapters:[]);try{let e=(Array.isArray(i.scenes)?i.scenes:[]).map(e=>null==e?void 0:e.chapterId).filter(e=>"number"==typeof e);G(e)}catch(e){}}}catch(e){console.error("DEBUG Outline: localStorage error =",e)}finally{$(!0)}},[]),(0,n.useEffect)(()=>{(async()=>{try{if(console.log("DEBUG Outline useEffect: hydrated =",H,"toc =",T),!H)return;let e=JSON.stringify({title:p,premise:g,ageRange:(0,m.RH)(f),genre:b,chaptersTarget:w,keypoints:N,style:C});try{let s=window.localStorage.getItem(t),i=s?JSON.parse(s):{};if(i.seedSignature!==e){let s={...i,seedSignature:e,toc:null,chapters:[]};try{window.localStorage.setItem(t,JSON.stringify(s))}catch(e){}_(null),z([])}}catch(e){}let i=new URLSearchParams(window.location.search),n=(null==i?void 0:i.get("reseed"))==="1";if(!n&&T&&0===M&&0===J.length){let e=(T||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,""),s=(0,d.B)(e),i=P(s,w);_(e),z(i);try{let s=window.localStorage.getItem(t),n={...s?JSON.parse(s):{},toc:e,chapters:i};window.localStorage.setItem(t,JSON.stringify(n))}catch(e){}return}if(!n&&T&&0===M||A.current)return;try{let t=window.sessionStorage.getItem(s);if(!n&&0===M&&t===e){console.log("DEBUG Outline: Seeding locked for signature, skipping duplicate call");return}}catch(e){}let r="Cannot access uninitialized variable",a=p&&!p.includes(r)?p:"",l=g&&!g.includes(r)?g:"";console.log("DEBUG Outline: evaluating seed readiness. titleSafe =",a,"premiseSafe =",l),R(!0),I(null),A.current=!0;try{window.sessionStorage.setItem(s,e)}catch(e){}if(!(a&&a.trim()||l&&l.trim())){console.log("DEBUG Outline: Missing title/premise after sanitize, setting error"),I("Missing seed info. Return and provide an idea or description."),R(!1);return}let c={title:a||"Untitled Codex",premise:l||a,prompt:l||a||"Untitled Codex",ageRange:(0,m.RH)(f),genre:b,chapters:w,keypoints:N||void 0,style:C,policyHint:"Fictionalize any sensitive or political content; avoid real names; keep it age-appropriate and non-political."};console.log("DEBUG Outline: Sending payload to seedStory @",(null===u.bV||void 0===u.bV?void 0:u.bV.seed)||"n/a","payload =",c);let{toc:o}=await (0,u.Mq)(c);console.log("DEBUG: Received TOC:",o);let h=(o||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,"");_(h);let x=(0,d.B)(h),y=P(x,w);z(y);try{let e=window.localStorage.getItem(t),s={...e?JSON.parse(e):{},toc:h,chapters:y};window.localStorage.setItem(t,JSON.stringify(s))}catch(e){}}catch(e){I((null==e?void 0:e.message)||"Seeding outline failed")}finally{R(!1),A.current=!1;try{window.sessionStorage.removeItem(s)}catch(e){}M>0&&Z(0)}})()},[H,M,p,g,f,b,w,N,C]),(0,i.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,i.jsx)("div",{className:"relative",children:(0,i.jsxs)("div",{className:"mx-auto max-w-6xl px-4 py-8",children:[(0,i.jsxs)("div",{className:"flex items-center gap-3",children:[(0,i.jsx)(a.E.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl bg-amber-200/70 p-2 shadow",children:(0,i.jsx)(l,{className:"h-6 w-6"})}),(0,i.jsx)(a.E.h1,{initial:{opacity:0,y:0},animate:{opacity:1,y:0},className:"text-2xl md:text-3xl font-serif tracking-wide",children:"Outline"})]}),(0,i.jsx)("p",{className:"mt-1 text-amber-900/80",children:p||"Untitled Codex"})]})}),(0,i.jsx)("main",{className:"relative mx-auto max-w-6xl px-4 pb-20",children:(0,i.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,i.jsx)("div",{className:"lg:col-span-1",children:(0,i.jsx)(o.T,{coverUrl:k,title:p||"Untitled Codex"})}),(0,i.jsxs)("div",{className:"lg:col-span-2",children:[(0,i.jsxs)("div",{className:"relative rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px]",children:[B&&(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,i.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,i.jsx)(c.Z,{className:"h-5 w-5 animate-spin"}),(0,i.jsx)("span",{children:"Engraving your table of contents…"})]})}),U&&(0,i.jsxs)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:[(0,i.jsx)("div",{children:U}),(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)("button",{onClick:()=>Z(e=>e+1),className:"rounded-lg bg-red-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]}),!B&&!U&&J.length>0&&(0,i.jsx)("ol",{className:"space-y-2",children:J.map(t=>{let s=D.includes(t.id);return(0,i.jsxs)("li",{className:"rounded-xl border p-3 cursor-pointer ".concat(s?"border-emerald-300 bg-emerald-50/60":"border-amber-200 bg-white/70"),onClick:()=>e.push({pathname:"/Read",query:{chapter:t.id,title:p||"Untitled Codex"}}),children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"font-serif font-semibold",children:[t.id,". ",t.heading]}),(0,i.jsx)("div",{className:"text-xs text-amber-900/70",children:s?"engraved":"tap to generate"})]}),t.synopsis&&(0,i.jsx)("div",{className:"text-sm text-amber-900/80",children:t.synopsis})]},t.id)})}),!B&&!U&&0===J.length&&(0,i.jsxs)("div",{className:"text-amber-900/80",children:[(0,i.jsx)("div",{children:"No chapters detected. The model may have declined or produced non-TOC text."}),(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)("button",{onClick:()=>Z(e=>e+1),className:"rounded-lg bg-amber-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]})]}),(0,i.jsx)("div",{className:"mt-4 flex justify-end gap-2",children:J.length>0&&D.length>=J.length&&(0,i.jsx)("button",{onClick:()=>e.push("/Read?export=1"),className:"inline-flex items-center justify-center rounded-xl bg-amber-600 text-white px-5 py-3 shadow hover:bg-amber-700",disabled:B,children:"Export Full Book"})})]})]})})]})}}},function(e){e.O(0,[295,891,379,888,774,179],function(){return e(e.s=4349)}),_N_E=e.O()}]);