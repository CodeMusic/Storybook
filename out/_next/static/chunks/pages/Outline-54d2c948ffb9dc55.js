(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{4349:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Outline",function(){return s(7563)}])},3432:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(1134).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},7326:function(e,t,s){"use strict";s.d(t,{T:function(){return i}});var a=s(5893),n=s(7294),r=s(9346);function i(e){let{coverUrl:t,title:s,onBroken:i}=e,[l,c]=(0,n.useState)(!1);return(0,a.jsxs)(r.Zb,{className:"bg-amber-50/80 border-amber-300 overflow-hidden",children:[t&&(0,a.jsx)("img",{src:t,alt:"Cover",className:"w-full aspect-[4/3] object-cover",onError:function(){if(!l){c(!0);try{i&&i()}catch(e){}}}}),(0,a.jsx)(r.Ol,{children:(0,a.jsx)(r.ll,{className:"text-amber-950",children:"Codex Core"})}),(0,a.jsxs)(r.aY,{className:"text-sm",children:[(0,a.jsx)("div",{className:"text-amber-900/70 uppercase text-xs",children:"Title"}),(0,a.jsx)("div",{className:"font-serif text-lg",children:s})]})]})}},9346:function(e,t,s){"use strict";s.d(t,{Ol:function(){return r},Zb:function(){return n},aY:function(){return l},ll:function(){return i}});var a=s(5893);s(7294);let n=e=>{let{className:t="",...s}=e;return(0,a.jsx)("div",{className:"rounded-2xl border bg-white ".concat(t),...s})},r=e=>{let{className:t="",...s}=e;return(0,a.jsx)("div",{className:"px-4 py-3 border-b ".concat(t),...s})},i=e=>{let{className:t="",...s}=e;return(0,a.jsx)("div",{className:"text-lg font-semibold ".concat(t),...s})},l=e=>{let{className:t="",...s}=e;return(0,a.jsx)("div",{className:"px-4 py-3 ".concat(t),...s})}},1207:function(e,t,s){"use strict";function a(e){let t=e.replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),s=[],a=1;function n(e,t){let n=e.replace(/^#{1,6}\s+/,"").trim(),r=(n=n.replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim())||"Chapter ".concat(a),i=(t||"").trim()||void 0;s.push({id:a++,heading:r,synopsis:i})}for(let e=0;e<t.length;e++){let s=t[e],a=s.match(/^\s*(?:\d+[\).]|[•\-*]|\d+\s+)\s*(.*)$/);if(a){let e=a[1].trim().split(/[—–\-:]\s+/);n((e[0]||"").replace(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i,"").trim(),(e.slice(1).join(" - ")||"").trim());continue}let r=s.match(/^#{1,6}\s+(.*)$/);if(r){if(/table of contents/i.test(r[1]))continue;let s=t[e+1],a=s&&!/^#{1,6}\s+/.test(s)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(s);n(r[1],a?s:void 0),a&&e++;continue}let i=s.match(/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*(.*)$/i);if(i){let s=t[e+1],a=s&&!/^(?:Chapter|Ch\.?|C)\s*\d+\s*[:.\-]\s*/i.test(s)&&!/^#{1,6}\s+/.test(s)&&!/^\s*(?:\d+[\).]|[•\-*])\s+/.test(s);n(i[1],a?s:void 0),a&&e++;continue}}return s}function n(e,t){let s=t.split(/\r?\n/).filter(Boolean).slice(0,2).join(", ");return"".concat(e,": ").concat(s,". Cozy watercolor, soft light, storybook composition, ancient relic/tech motif.")}s.d(t,{B:function(){return a},Z:function(){return n}})},7563:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return p}});var a=s(5893),n=s(7294),r=s(1163),i=s(1891);let l=(0,s(1134).Z)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]]);var c=s(3432),o=s(7326),d=s(1207),u=s(2743),m=s(8914);function p(){let e=(0,r.useRouter)(),t="storyforge.session.v1",[s,p]=(0,n.useState)(""),[h,x]=(0,n.useState)(""),[g,f]=(0,n.useState)((0,m.RH)("6-8")),[b,y]=(0,n.useState)("fantasy"),[v,N]=(0,n.useState)(8),[S,j]=(0,n.useState)(""),[w,C]=(0,n.useState)("warm, whimsical, gentle-humor"),[O,E]=(0,n.useState)(null),[k,R]=(0,n.useState)(!0),[B,U]=(0,n.useState)(null),[T,_]=(0,n.useState)(null),[I,J]=(0,n.useState)([]),[z,H]=(0,n.useState)([]),[D,G]=(0,n.useState)(!1),[M,Z]=(0,n.useState)(0),$=(0,n.useRef)(!1);function A(e,t){let s=Math.max(1,Math.floor(t||0)),a=e.slice(0,s).map((e,t)=>({...e,id:t+1}));if(a.length===s)return a;let n=[];for(let e=a.length;e<s;e++)n.push({id:e+1,heading:"Chapter ".concat(e+1),synopsis:void 0});return[...a,...n]}return(0,n.useEffect)(()=>{try{let s=window.localStorage.getItem(t);if(s){var e;let a=JSON.parse(s),n=new URLSearchParams(window.location.search),r=(null==n?void 0:n.get("reseed"))==="1";if(a.premise&&a.premise.includes("Cannot access uninitialized variable")){console.log("DEBUG: Sanitizing corrupted premise in localStorage"),a.premise="";try{window.localStorage.setItem(t,JSON.stringify(a))}catch(e){}}if(p(null!==(e=a.title)&&void 0!==e?e:""),x(a.premise||""),f((0,m.RH)(a.ageRange||"6-8")),y(a.genre||"fantasy"),N("number"==typeof a.chaptersTarget?a.chaptersTarget:8),j(a.keypoints||""),C(a.style||"warm, whimsical, gentle-humor"),E(a.coverUrl||null),r){_(null),J([]);try{let e={...a,toc:null,chapters:[],seedSignature:void 0};window.localStorage.setItem(t,JSON.stringify(e))}catch(e){}}else _(a.toc||null),J(Array.isArray(a.chapters)?a.chapters:[]);try{let e=(Array.isArray(a.scenes)?a.scenes:[]).map(e=>null==e?void 0:e.chapterId).filter(e=>"number"==typeof e);H(e)}catch(e){}}}catch(e){console.error("DEBUG Outline: localStorage error =",e)}finally{G(!0)}},[]),(0,n.useEffect)(()=>{(async()=>{try{if(console.log("DEBUG Outline useEffect: hydrated =",D,"toc =",T),!D)return;let e=JSON.stringify({title:s,premise:h,ageRange:(0,m.RH)(g),genre:b,chaptersTarget:v,keypoints:S,style:w});try{let s=window.localStorage.getItem(t),a=s?JSON.parse(s):{};if(a.seedSignature!==e){let s={...a,seedSignature:e,toc:null,chapters:[]};try{window.localStorage.setItem(t,JSON.stringify(s))}catch(e){}_(null),J([])}}catch(e){}let a=new URLSearchParams(window.location.search),n=(null==a?void 0:a.get("reseed"))==="1";if(!n&&T&&0===M&&0===I.length){let e=(T||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,""),s=(0,d.B)(e),a=A(s,v);_(e),J(a);try{let s=window.localStorage.getItem(t),n={...s?JSON.parse(s):{},toc:e,chapters:a};window.localStorage.setItem(t,JSON.stringify(n))}catch(e){}return}if(!n&&T&&0===M||$.current)return;let r="Cannot access uninitialized variable",i=s&&!s.includes(r)?s:"",l=h&&!h.includes(r)?h:"";if(console.log("DEBUG Outline: evaluating seed readiness. titleSafe =",i,"premiseSafe =",l),R(!0),U(null),$.current=!0,!(i&&i.trim()||l&&l.trim())){console.log("DEBUG Outline: Missing title/premise after sanitize, setting error"),U("Missing seed info. Return and provide an idea or description."),R(!1);return}let c={title:i||"Untitled Codex",premise:l||i,prompt:l||i||"Untitled Codex",ageRange:(0,m.RH)(g),genre:b,chapters:v,keypoints:S||void 0,style:w,policyHint:"Fictionalize any sensitive or political content; avoid real names; keep it age-appropriate and non-political."};console.log("DEBUG Outline: Sending payload to seedStory @",(null===u.bV||void 0===u.bV?void 0:u.bV.seed)||"n/a","payload =",c);let{toc:o}=await (0,u.Mq)(c);console.log("DEBUG: Received TOC:",o);let p=(o||"").replace(/```[\s\S]*?```/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/^[^\n]*Table of Contents[^\n]*\n?/i,"").replace(/^Based on[\s\S]*?:\n+/i,"");_(p);let x=(0,d.B)(p),f=A(x,v);J(f);try{let e=window.localStorage.getItem(t),s={...e?JSON.parse(e):{},toc:p,chapters:f};window.localStorage.setItem(t,JSON.stringify(s))}catch(e){}}catch(e){U((null==e?void 0:e.message)||"Seeding outline failed")}finally{R(!1),$.current=!1,M>0&&Z(0)}})()},[D,M,s,h,g,b,v,S,w]),(0,a.jsxs)("div",{className:"min-h-screen text-amber-950",children:[(0,a.jsx)("div",{className:"relative",children:(0,a.jsxs)("div",{className:"mx-auto max-w-6xl px-4 py-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(i.E.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{delay:.1},className:"rounded-2xl bg-amber-200/70 p-2 shadow",children:(0,a.jsx)(l,{className:"h-6 w-6"})}),(0,a.jsx)(i.E.h1,{initial:{opacity:0,y:0},animate:{opacity:1,y:0},className:"text-2xl md:text-3xl font-serif tracking-wide",children:"Outline"})]}),(0,a.jsx)("p",{className:"mt-1 text-amber-900/80",children:s||"Untitled Codex"})]})}),(0,a.jsx)("main",{className:"relative mx-auto max-w-6xl px-4 pb-20",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsx)("div",{className:"lg:col-span-1",children:(0,a.jsx)(o.T,{coverUrl:O,title:s||"Untitled Codex"})}),(0,a.jsxs)("div",{className:"lg:col-span-2",children:[(0,a.jsxs)("div",{className:"relative rounded-2xl border border-amber-300 bg-amber-50/70 p-4 min-h-[240px]",children:[k&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center rounded-2xl bg-amber-100/60 backdrop-blur-sm",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 text-amber-900",children:[(0,a.jsx)(c.Z,{className:"h-5 w-5 animate-spin"}),(0,a.jsx)("span",{children:"Engraving your table of contents…"})]})}),B&&(0,a.jsxs)("div",{className:"rounded-xl border border-red-300 bg-red-50 p-3 text-red-800",children:[(0,a.jsx)("div",{children:B}),(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("button",{onClick:()=>Z(e=>e+1),className:"rounded-lg bg-red-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]}),!k&&!B&&I.length>0&&(0,a.jsx)("ol",{className:"space-y-2",children:I.map(t=>{let n=z.includes(t.id);return(0,a.jsxs)("li",{className:"rounded-xl border p-3 cursor-pointer ".concat(n?"border-emerald-300 bg-emerald-50/60":"border-amber-200 bg-white/70"),onClick:()=>e.push({pathname:"/Read",query:{chapter:t.id,title:s||"Untitled Codex"}}),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"font-serif font-semibold",children:[t.id,". ",t.heading]}),(0,a.jsx)("div",{className:"text-xs text-amber-900/70",children:n?"engraved":"tap to generate"})]}),t.synopsis&&(0,a.jsx)("div",{className:"text-sm text-amber-900/80",children:t.synopsis})]},t.id)})}),!k&&!B&&0===I.length&&(0,a.jsxs)("div",{className:"text-amber-900/80",children:[(0,a.jsx)("div",{children:"No chapters detected. The model may have declined or produced non-TOC text."}),(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("button",{onClick:()=>Z(e=>e+1),className:"rounded-lg bg-amber-600 text-white px-3 py-1 text-xs",children:"Retry seeding"})})]})]}),(0,a.jsx)("div",{className:"mt-4 flex justify-end gap-2",children:I.length>0&&z.length>=I.length&&(0,a.jsx)("button",{onClick:()=>e.push("/Read?export=1"),className:"inline-flex items-center justify-center rounded-xl bg-amber-600 text-white px-5 py-3 shadow hover:bg-amber-700",disabled:k,children:"Export Full Book"})})]})]})})]})}}},function(e){e.O(0,[295,891,379,888,774,179],function(){return e(e.s=4349)}),_N_E=e.O()}]);