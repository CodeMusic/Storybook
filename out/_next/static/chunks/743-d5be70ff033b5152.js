"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[743],{2743:function(t,e,n){n.d(e,{$y:function(){return d},Mq:function(){return v},WF:function(){return C},Yl:function(){return S},bV:function(){return s},km:function(){return A},nq:function(){return x},o9:function(){return k},qQ:function(){return N},tH:function(){return a},vz:function(){return U}});var r=n(4406),o=n(8834).lW;let a="https://n8n.codemusic.ca/webhook",i=r.env.NEXT_PUBLIC_N8N_USER||"siteuser",l=r.env.NEXT_PUBLIC_N8N_PASS||"codemusai",c="storyforge.sessionId.v1",s={prime:"".concat(a,"/seedInfo"),seed:"".concat(a,"/seedStory"),chapter:"".concat(a,"/expandChapter"),image:"".concat(a,"/genImage"),export:"".concat(a,"/exportBook"),voice:"".concat(a,"/voiceforge"),exportStory:"".concat(a,"/exportStory")};function p(){let t="".concat(i,":").concat(l);try{let e="function"==typeof btoa?btoa(t):o.from(t).toString("base64");return"Basic ".concat(e)}catch(t){return""}}function u(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:6e5,r=new AbortController,o=setTimeout(()=>r.abort(),n);return fetch(t,{...e,signal:r.signal}).finally(()=>clearTimeout(o))}function d(){let t=f();try{window.localStorage.setItem(c,t)}catch(t){}return t}function f(){try{if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return crypto.randomUUID();if("undefined"!=typeof crypto&&crypto.getRandomValues){let t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128;let e=Array.from(t,t=>t.toString(16).padStart(2,"0")).join("");return"".concat(e.slice(0,8),"-").concat(e.slice(8,12),"-").concat(e.slice(12,16),"-").concat(e.slice(16,20),"-").concat(e.slice(20))}}catch(t){}return"sid_".concat(Date.now().toString(36),"_").concat(Math.random().toString(36).slice(2,10))}function h(t){return{...t&&"object"==typeof t?t:{},sessionId:function(){try{{let t=window.localStorage.getItem(c);if(t&&t.trim())return t;let e=f();return window.localStorage.setItem(c,e),e}}catch(t){}return f()}()}}async function m(t,e){let n=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:p()},body:JSON.stringify(h(e))}),r=await n.text();if(!n.ok)throw Error(r||"Endpoint error ".concat(n.status));if(!r)throw Error("Empty response");return r}async function g(t,e){let n=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:p()},body:JSON.stringify(h(e))}),r=await n.text();if(!n.ok)throw Error(r||"Endpoint error ".concat(n.status));try{return JSON.parse(r)}catch(t){throw Error("Invalid JSON response")}}async function y(t,e){let n=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:p()},body:JSON.stringify(h(e))}),r=await n.text();if(!n.ok)throw Error(r||"Endpoint error ".concat(n.status));return r}function w(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}function b(t){if(!t)return t;let e=t.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");return(e=e.replace(/&#(\d+);/g,(t,e)=>String.fromCharCode(parseInt(e,10)))).replace(/&#x([0-9a-fA-F]+);/g,(t,e)=>String.fromCharCode(parseInt(e,16)))}async function v(t){console.log("DEBUG seedStory: endpoint =",s.seed),console.log("DEBUG seedStory: payload =",t);try{let e=await m(s.seed,t);console.log("DEBUG seedStory: raw response =",e);let n=function(t){let e=(t||"").toString().trim();if(!e)return e;try{let t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){let e=t[0];if("string"==typeof(null==e?void 0:e.toc))return e.toc;if("string"==typeof(null==e?void 0:e.output))return e.output}if("object"==typeof t&&t){if("string"==typeof t.toc)return t.toc;if("string"==typeof t.output)return t.output}}catch(t){}return e}(e);if(function(t){let e=(t||"").toLowerCase();if(!e)return!1;let n=["i cannot","i can't","i wonâ€™t","i will not","as an ai","goes against my guidelines","i'm unable to","i am unable to","cannot create a story seed","policy","sensitive"].some(t=>e.includes(t)),r=/chapter\s*\d|table of contents|^\s*\d+[\).]/m.test(e);return n&&!r}(n))throw Error("The model declined to create an outline. We'll fictionalize sensitive content and avoid real names. Please retry.");return console.log("DEBUG seedStory: parsed toc =",n),{toc:n}}catch(t){throw console.error("DEBUG seedStory: error =",t),t}}async function S(t){return{html:function t(e){let n=(e||"").toString().trim();if(!n)return"";try{let e=JSON.parse(n);if(Array.isArray(e)&&e.length>0){let n=e[0];if("string"==typeof(null==n?void 0:n.html)){let t=n.html;return/[<][a-zA-Z!/?]/.test(t)?t:b(t).split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>{let e=w(t).replace(/\n/g,"<br/>");return"<p>".concat(e,"</p>")}).join("\n")}if("string"==typeof(null==n?void 0:n.output))return t(n.output)}if("object"==typeof e&&e){if("string"==typeof e.html){let t=e.html;return/[<][a-zA-Z!/?]/.test(t)?t:b(t).split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>{let e=w(t).replace(/\n/g,"<br/>");return"<p>".concat(e,"</p>")}).join("\n")}if("string"==typeof e.output)return t(e.output)}}catch(t){}let r=b(n);return/[<][a-zA-Z!/?]/.test(r)?r:r.split(/\n{2,}/).map(t=>t.trim()).filter(Boolean).map(t=>{let e=w(t).replace(/\n/g,"<br/>");return"<p>".concat(e,"</p>")}).join("\n")}(await m(s.chapter,t))}}async function*x(t){var e;let n=await u(s.chapter,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/x-ndjson, text/event-stream;q=0.9, text/plain;q=0.8, */*;q=0.1",Authorization:p()},body:JSON.stringify(h(t))});if(!n.ok)throw Error(await n.text().catch(()=>"")||"Endpoint error ".concat(n.status));let r=n.headers.get("content-type")||"",o=null===(e=n.body)||void 0===e?void 0:e.getReader();if(!o){let t=await n.text();yield t;return}let a=new TextDecoder,i="",l=/text\/event-stream/i.test(r);for(;;){let{value:t,done:e}=await o.read();if(e)break;let n=a.decode(t,{stream:!0});if(!n)continue;if(l){let t=(i+=n).split(/\r?\n/);for(let e of(i=t.pop()||"",t)){if(!e.startsWith("data:"))continue;let t=e.slice(5).trimStart();if(t&&"[DONE]"!==t)try{let e=JSON.parse(t);e&&"item"===e.type&&"string"==typeof e.content?yield e.content:"string"==typeof e&&(yield e)}catch(e){yield t+"\n"}}continue}i+=n;let r=(i=i.replace(/}\s*\{/g,"}\n{")).split(/\r?\n/);for(let t of(i=r.pop()||"",r)){let e=t.trim();if(e)for(let t of e.replace(/}\s*\{/g,"}\n{").split(/\r?\n/)){let e=t.trim();if(e&&"[DONE]"!==e)try{let t=JSON.parse(e);(null==t?void 0:t.type)==="item"&&"string"==typeof t.content?yield t.content:"string"==typeof t&&(yield t)}catch(t){i=e}}}}let c=(i||"").trim();if(c&&"[DONE]"!==c)try{let t=JSON.parse(c);(null==t?void 0:t.type)==="item"&&"string"==typeof t.content?yield t.content:"string"==typeof t&&(yield t)}catch(t){}}async function E(t,e){let n=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:p()},body:JSON.stringify(h(e))}),r=n.headers.get("content-type")||"";if(!n.ok)throw Error(await n.text().catch(()=>"")||"Endpoint error ".concat(n.status));if(r.startsWith("image/")){let t=await n.blob();return URL.createObjectURL(t)}let o=await n.text();try{let t=JSON.parse(o);if("string"==typeof(null==t?void 0:t.url))return t.url;if("string"==typeof(null==t?void 0:t.data)){let e=(null==t?void 0:t.mime)||(null==t?void 0:t.type)||"image/png";if(t.data.startsWith("data:"))return t.data;return"data:".concat(e,";base64,").concat(t.data)}}catch(t){}let a=o.trim();if(!a)throw Error("Empty response");return a}async function A(t){return{url:await E(s.image,{prompt:t})}}async function O(t,e){let n=await u(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:p()},body:JSON.stringify(h(e))}),r=n.headers.get("content-type")||"";if(!n.ok)throw Error(await n.text().catch(()=>"")||"Endpoint error ".concat(n.status));if(/^audio\//i.test(r)){let t=await n.blob();return URL.createObjectURL(t)}let o=await n.text();try{let t=JSON.parse(o);if("string"==typeof(null==t?void 0:t.url))return t.url;if("string"==typeof(null==t?void 0:t.data)){let e=(null==t?void 0:t.mime)||(null==t?void 0:t.type)||"audio/mpeg";if(t.data.startsWith("data:"))return t.data;return"data:".concat(e,";base64,").concat(t.data)}}catch(t){}let a=o.trim();if(!a)throw Error("Empty response");return a}async function U(t){return{url:await O(s.voice,{prompt:t})}}async function C(t){try{var e;let{htmlPages:r,scenes:o,coverUrl:a,meta:i}=t||{},l=((null==i?void 0:i.title)||"Untitled Codex").toString(),c=l.replace(/[^a-z0-9\- _\(\)\[\]]+/gi,"_").trim()||"storybook",s=Array.isArray(null==i?void 0:i.chapters)?i.chapters:[];async function n(t){let e=(t||"").toString();if(!e)return null;if(!e.startsWith("blob:"))return e;try{let t=await fetch(e),n=await t.blob();return await new Promise(t=>{let e=new FileReader;e.onloadend=()=>t(e.result),e.readAsDataURL(n)})}catch(t){return null}}let p=Array.isArray(o)&&o.length?o.map(t=>({id:t.chapterId,heading:t.chapterHeading,html:t.html,imageUrl:t.imageUrl})):(Array.isArray(r)?r:[]).map((t,e)=>{var n,r,o,a;return{id:null!==(o=null===(n=s[e])||void 0===n?void 0:n.id)&&void 0!==o?o:e+1,heading:null!==(a=null===(r=s[e])||void 0===r?void 0:r.heading)&&void 0!==a?a:"Chapter ".concat(e+1),html:t,imageUrl:null}}),u=await Promise.all(p.map(async t=>({...t,imageUrl:await n(t.imageUrl)}))),d=await n(a),f=u.length?'<section class="toc card">\n  <h2>Table of Contents</h2>\n  <ol class="toc-list">\n    '.concat(u.map(t=>'<li><a href="#chapter-'.concat(t.id,'">').concat(t.id,". ").concat(w(t.heading),"</a></li>")).join("\n    "),"\n  </ol>\n</section>"):"",h=u.map(t=>'\n<article class="chapter" id="chapter-'.concat(t.id,'">\n  <h2 class="chapter-title">Chapter ').concat(t.id,": ").concat(w(t.heading),"</h2>\n  ").concat(t.imageUrl?'<img src="'.concat(t.imageUrl,'" alt="Chapter ').concat(t.id,' image" />'):"",'\n  <div class="prose dropcap">').concat(t.html,"</div>\n</article>")).join("\n\n<hr/>\n\n"),m='<!doctype html>\n<html lang="en">\n<head>\n  <meta charset="utf-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1" />\n  <title>'.concat(l,'</title>\n  <link rel="preconnect" href="https://fonts.googleapis.com">\n  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n  <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">\n  <style>\n    body { color:#451a03; background:#fffbeb; font-family: \'Crimson Text\', ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; margin: 24px; font-size: 18px; line-height: 1.85; }\n    h1, h2, h3 { font-family: \'IM Fell English\', ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; color:#7c2d12; }\n    .container { max-width: 780px; margin: 0 auto; }\n    .card { background: rgba(255, 237, 213, 0.6); border: 1px solid #fdba74; border-radius: 16px; padding: 16px; }\n    .meta { color:#92400e; font-size: 0.9rem; }\n    hr { border:0; border-top:1px solid #fed7aa; margin: 24px 0; }\n    .chapter { margin: 16px 0; }\n    .chapter img { max-width:100%; height:auto; border-radius: 8px; border:1px solid #fcd34d; }\n    .prose p { line-height: 1.85; margin: 10px 0; font-size: 1.05em; }\n    .toc-list { margin: 8px 0 0 20px; }\n    .toc-list li { margin: 6px 0; }\n    .chapter-title { margin-bottom: 8px; color:#7c2d12; font-size: 1.8rem; }\n    /* Drop cap for first paragraph */\n    .dropcap p:first-of-type::first-letter { float:left; font-family: \'IM Fell English\', ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; font-size: 3.2rem; line-height: 1; padding-right: 0.22rem; padding-top: 0.12rem; font-weight: 700; color:#7c2d12; }\n  </style>\n  <meta name="generator" content="Storyforge" />\n  <meta name="description" content="Exported Storyforge book" />\n  <meta name="author" content="Storyforge" />\n  <meta name="storyforge:title" content="').concat(l,'" />\n  <meta name="storyforge:chapters" content="').concat(((null==i?void 0:null===(e=i.chapters)||void 0===e?void 0:e.length)||0).toString(),'" />\n  <script>/* Standalone export generated locally without server dependency */</script>\n  <link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 16 16\'><text y=\'14\' font-size=\'14\'>\uD83D\uDCDC</text></svg>">\n  <meta name="color-scheme" content="light" />\n  <meta name="theme-color" content="#f59e0b" />\n  <meta name="apple-mobile-web-app-capable" content="yes" />\n  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />\n  <meta name="apple-mobile-web-app-title" content="').concat(l,'" />\n  <meta name="format-detection" content="telephone=no" />\n  <meta name="mobile-web-app-capable" content="yes" />\n</head>\n<body>\n  <main class="container">\n    <div class="card">\n      <h1>').concat(l,"</h1>\n      ").concat(d?'<img src="'.concat(d,'" alt="Cover" style="max-width:100%;height:auto;border:1px solid #e2c084;border-radius:12px;margin:12px 0;"/>'):"","\n    </div>\n    ").concat(f,'\n    <section class="chapters">\n      ').concat(h,"\n    </section>\n  </main>\n</body>\n</html>"),g=new Blob([m],{type:"text/html;charset=utf-8"});return{downloadUrl:URL.createObjectURL(g),filename:"".concat(c,".html")}}catch(e){try{return{downloadUrl:await m(s.export,t)}}catch(t){return{downloadUrl:null}}}}async function N(t){try{var e,n,r,o,a;let i={title:((null==t?void 0:null===(e=t.meta)||void 0===e?void 0:e.title)||"Untitled Codex").toString(),toc:null!==(o=null==t?void 0:null===(n=t.meta)||void 0===n?void 0:n.toc)&&void 0!==o?o:null,chapters:Array.isArray(null==t?void 0:null===(r=t.meta)||void 0===r?void 0:r.chapters)?t.meta.chapters:[],scenes:Array.isArray(null==t?void 0:t.scenes)?t.scenes:[],coverUrl:null!==(a=null==t?void 0:t.coverUrl)&&void 0!==a?a:null,htmlPages:Array.isArray(null==t?void 0:t.htmlPages)?t.htmlPages:void 0,exportedAt:new Date().toISOString()};await u(s.exportStory,{method:"POST",headers:{"Content-Type":"application/json",Authorization:p()},body:JSON.stringify(h(i))}).then(()=>{}).catch(()=>{})}catch(t){}}function T(t){let e;let n=(t||"").toString().trim();if(!n)return null;let r=/\(\s*({[\s\S]*?})\s*\)\s*,?/g,o=[];for(;null!==(e=r.exec(n));){let t=(e[1]||"").trim();try{let e=JSON.parse(t);e&&"object"==typeof e&&o.push(e)}catch(t){}}if(!o.length)return null;let a=o[0]||{},i={title:a.title,description:a.description,ageRange:a.ageRange,genre:a.genre,chapters:"number"==typeof a.chapters?a.chapters:parseInt(String(a.chapters||""),10)||void 0,chapterLength:a.chapterLength,keypoints:a.keypoints,style:a.style};return Object.values(i).some(t=>null!=t&&""!==t)?i:null}async function k(t){try{let e=await g(s.prime,t),n=t=>{let e=(t||"").trim(),n=T(e);if(n)return n;let r=e.match(/```\s*json\s*([\s\S]*?)```/i)||e.match(/```\s*([\s\S]*?)```/i),o=(r?r[1]:e).trim();o=o.replace(/^\s*\(\s*/,"").replace(/\s*\)\s*$/,"");try{let t=JSON.parse(o);if(t&&"object"==typeof t){let e={title:t.title,description:t.description,ageRange:t.ageRange,genre:t.genre,chapters:t.chapters,chapterLength:t.chapterLength,keypoints:t.keypoints,style:t.style};if(Object.values(e).some(t=>null!=t&&""!==t))return e}}catch(t){}let a=e.split(/\r?\n/).filter(Boolean);return a.length>=3&&a.slice(0,3).every(t=>/^(\s*(\d+[\).]|[â€¢\-*])\s*)?/.test(t))?{toc:e}:{description:e}};if(Array.isArray(e)&&e.length>0){let t=e[0];if("string"==typeof(null==t?void 0:t.output))return{info:n(t.output)};if(t&&"object"==typeof t)return{info:t}}if("string"==typeof(null==e?void 0:e.output))return{info:n(e.output)};return{info:e}}catch(e){try{let e=(await y(s.prime,t)||"").toString().trim(),n=T(e);if(n)return{info:n};return{info:e?{description:e}:{}}}catch(t){throw t}}}}}]);